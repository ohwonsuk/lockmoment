# 배포 노트 - 예약 잠금 동기화 수정

부모 앱에서 생성된 예약 잠금이 자녀 앱에 제대로 동기화되지 않는 문제를 해결했습니다.

## 주요 수정 사항

1.  **`LockService` 내 강력한 동기화 구현:**
    -   서버에서 최신 스케줄을 가져오는 `syncSchedules` 메서드를 구현했습니다.
    -   **로컬 저장소 덮어쓰기 (Strict Sync)**: 로컬 저장소를 서버 데이터와 완벽하게 일치시킵니다. 서버에 없는 로컬 스케줄(예: 삭제된 항목)은 자동으로 삭제됩니다.
    -   **네이티브 알람 업데이트**: 동기화된 서버 데이터를 기반으로 네이티브 알람을 자동으로 등록하거나 취소합니다.

2.  **대시보드 통합 개선:**
    -   `DashboardScreen`을 단순화하여 앱 시작 시(`refreshAll`) 동기화를 트리거하고, 동기화 완료 후 로컬 저장소의 데이터를 로드하도록 변경했습니다.

3.  **백엔드 검증:**
    -   Lambda 엔드포인트 `GET /parent-child/{childId}/schedules`가 자녀 사용자(본인)의 스케줄 조회를 올바르게 허용하는지 확인했습니다.

## 검증 방법

1.  자녀 앱(Child App)을 다시 빌드(Rebuild)합니다.
2.  자녀 계정으로 로그인합니다.
3.  앱 시작 시 자동으로 동기화가 수행됩니다. 부모 앱에서 생성한 스케줄이 나타나고, 서버에 없는 오래된 로컬 스케줄은 삭제되어야 합니다.
## 추가 수정 사항 (API 오류 및 QR 저장 문제 해결)

1.  **API 페이로드 매핑 수정 (`ParentChildService.ts`):**
    -   `createChildSchedule` 및 `updateChildSchedule` 메서드에서 서버가 기대하는 `snake_case` 형식(`start_time`, `lock_type` 등)으로 데이터를 변환하여 전송하도록 수정했습니다. 이로 인해 "필수 정보가 누락되었습니다" 오류가 해결되었습니다.

2.  **QR 생성 시 예약 저장 강제 (`QRGeneratorScreen.tsx`):**
    -   "예약 잠금(SCHEDULED)" 유형의 QR 생성 시, 먼저 서버에 예약 정보를 저장하도록 로직을 변경했습니다.
    -   저장이 성공해야만 QR 코드가 생성됩니다. 이를 통해 자녀가 QR을 스캔하더라도 서버에 데이터가 존재하므로, 앱 동기화 시 스케줄이 유지됩니다.

## 최종 검증 방법

1.  **부모 앱:**
    -   "예약 잠금" 생성 및 저장을 시도합니다. 오류 없이 성공해야 합니다.
    -   QR 생성 버튼을 누릅니다. 내부적으로 저장이 수행되고 성공 시 QR이 표시되어야 합니다.
2.  **자녀 앱:**
    -   생성된 QR을 스캔하거나, 앱을 재시작하여 동기화를 확인합니다.
    -   부모가 생성한 스케줄이 정상적으로 표시되고 유지되어야 합니다.


## 추가 수정 사항 3 (iOS 예약 잠금 고도화 및 동기화)

iOS의 스케줄 잠금은 시스템(`DeviceActivity`)에 의해 제어되므로 앱과 확장 프로그램(Extension) 간의 데이터 동기화가 가장 중요합니다.

1.  **데이터 공유 고도화 (`LockModel`, `LockControlModule`)**:
    -   `FamilyActivitySelection` 저장 시 `PropertyListEncoder`를 사용하도록 수정하여 데이터 무결성을 확보했습니다.
    -   정책(Policy) 데이터에 시작/종료 시간 정보를 포함하여, 앱이 실행될 때 현재 시간이 예약 범위 내인지 스스로 판단하고 잠금을 즉시 적용하는 기능을 추가했습니다.
    -   메인 앱과 Extension이 동일한 **Named ManagedSettingsStore**(`com.lockmoment.store`)를 공유하도록 설정했습니다.

2.  **백그라운드 상태 동기화 (`DeviceActivityMonitorExtension`)**:
    -   Extension이 잠금을 시작하거나 종료할 때 `isLocked` 상태값을 공유 저장소에 업데이트하여, 부모 앱이나 자녀 앱 UI에 즉시 반영되도록 개선했습니다.

## iOS 예약 잠금 미동작 시 체크리스트 (반드시 확인)

1.  **스케줄 재저장 (필수)**: 
    -   코드가 수정된 후, 기존에 등록된 스케줄을 **수정 모드에서 다시 '저장'**하십시오. 그래야 새로운 형식의 정책 데이터가 공유 저장소에 기록되고 시스템 모니터링이 시작됩니다.
2.  **App Group ID 확인**: 
    -   Xcode의 메인 타겟과 Extension 타겟 모두 `group.com.lockmoment`가 올바르게 등록되어 있는지 다시 확인하십시오.
3.  **로그인 및 권한**: 
    -   스크린 타임 권한(`FamilyControls`)이 승인된 상태여야 합니다.

1.  **부모 앱 상태 확인:**
    -   자녀의 예약 잠금 시간대에 부모 앱에서 자녀 목록을 조회합니다.
    -   자녀가 앱을 켜지 않아도 상태가 '잠금 중'으로 표시되어야 합니다.

2.  **안드로이드 자녀 폰 잠금 확인:**
    -   예약 잠금이 설정된 상태에서 락모먼트 앱을 종료(Force Close)하거나 백그라운드에 둡니다.
    -   예약 시간이 되면(또는 이미 지났다면) 다른 앱 실행 시 잠금 화면이 나타나는지 확인합니다.
