-- ì•± ê¶Œí•œìƒíƒœ ì¶”ì  ëŒ€ì‘ Devices ë° ë‹¤ë¥¸ í…Œì´ë¸” ì‚­ì œ í›„ ì¬ìƒì„±(260210)

-- enum ìƒì„±ë¶€í„° ì§„
-- ë””ë°”ì´ìŠ¤ í”Œë«í¼
CREATE TYPE device_platform_enum AS ENUM ('IOS', 'ANDROID');

-- ë””ë°”ì´ìŠ¤ ìƒíƒœ
CREATE TYPE device_status_enum AS ENUM ('ACTIVE', 'INACTIVE', 'REVOKED');

-- ê¶Œí•œ ìƒíƒœ (ë‹¨ìˆœ Booleanë³´ë‹¤ í™•ì¥ì„± í™•ë³´)
CREATE TYPE permission_state_enum AS ENUM (
  'GRANTED',
  'DENIED',
  'NOT_DETERMINED'
);

-- Devices í…Œì´ë¸” ì‚­ì  
DROP TABLE IF EXISTS devices CASCADE;

-- devices í…Œì´ë¸” ìƒì„± (260210)
CREATE TABLE devices (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  
  -- user_id: ì‹¤ì œ ê¸°ê¸° ì‚¬ìš©ì (ìë…€/í•™ìƒ)
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,

  platform device_platform_enum NOT NULL,

  -- ë””ë°”ì´ìŠ¤ ì‹ë³„
  device_uuid VARCHAR(255) NOT NULL UNIQUE,
  device_model VARCHAR(100),
  os_version VARCHAR(20),
  app_version VARCHAR(20),

  -- ğŸ” ê¶Œí•œ ìƒíƒœ (í•µì‹¬)
  accessibility_permission permission_state_enum, -- Android ì ‘ê·¼ì„± / iOS í•´ë‹¹ ì—†ìŒ
  screen_time_permission permission_state_enum,   -- iOS Family Controls
  notification_permission permission_state_enum,

  -- ê¶Œí•œ ë™ê¸°í™” ì‹œì 
  last_permission_sync TIMESTAMPTZ,

  -- ìƒíƒœ ê´€ë¦¬
  status device_status_enum DEFAULT 'ACTIVE',
  is_active BOOLEAN DEFAULT TRUE,

  -- ì ‘ì† ì •ë³´
  last_seen_at TIMESTAMPTZ,

  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);

ALTER TABLE devices
ADD CONSTRAINT chk_ios_permissions
CHECK (
  platform <> 'IOS'
  OR accessibility_permission IS NULL
);

-- updated_at ìë™ ê°±ì‹  íŠ¸ë¦¬ê±° (260210)
CREATE OR REPLACE FUNCTION set_updated_at()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = now();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_devices_updated_at
BEFORE UPDATE ON devices
FOR EACH ROW
EXECUTE FUNCTION set_updated_at();

-- ì¸ë±ìŠ¤ìƒì„± (260210)
-- ì‚¬ìš©ì â†’ ë””ë°”ì´ìŠ¤ ì¡°íšŒ (ë¶€ëª¨/êµì‚¬ í™”ë©´ í•µì‹¬)
CREATE INDEX idx_devices_user_id
  ON devices(user_id);

-- í™œì„± ë””ë°”ì´ìŠ¤ í•„í„°ë§
CREATE INDEX idx_devices_active
  ON devices(is_active)
  WHERE is_active = TRUE;

-- ìµœê·¼ ì ‘ì† ê¸°ì¤€
CREATE INDEX idx_devices_last_seen
  ON devices(last_seen_at DESC);

-- ê¶Œí•œ ìƒíƒœ ëª¨ë‹ˆí„°ë§ (ìš´ì˜/ì•Œë¦¼ìš©)
CREATE INDEX idx_devices_permission_sync
  ON devices(last_permission_sync);

-- ìš”ì¼ enum
CREATE TYPE day_of_week_enum AS ENUM (
  'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT', 'SUN'
);

-- ìŠ¤ì¼€ì¤„ ìƒíƒœ
CREATE TYPE schedule_status_enum AS ENUM (
  'ACTIVE',
  'PAUSED',
  'DELETED'
);

-- ê¸°ì¡´ parent_child í…Œì´ë¸” ì‚­ì œ (260210)
DROP TABLE IF EXISTS parent_child CASCADE;

-- ì‹ ê·œ parent_child_relaltion í…Œì´ë¸” ìƒì„± (260214)
CREATE TABLE parent_child_relations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  parent_user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  child_user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,

  nickname VARCHAR(50), -- ë¶€ëª¨ê°€ ì„¤ì •í•œ ìë…€ì˜ ì´ë¦„(ë³„ëª…)
  is_primary BOOLEAN DEFAULT FALSE, -- ì£¼ ë³´í˜¸ì ì—¬ë¶€
  created_at TIMESTAMPTZ DEFAULT now(),

  CONSTRAINT uq_parent_child UNIQUE (parent_user_id, child_user_id)
);

-- ì¡°íšŒ ìµœì í™”
CREATE INDEX idx_parent_child_parent
  ON parent_child_relations(parent_user_id);

CREATE INDEX idx_parent_child_child
  ON parent_child_relations(child_user_id);

-- ìë…€ ìŠ¤ì¼€ì¥´ í…Œì´ë¸” ìƒì„± (260210)
CREATE TABLE child_schedules (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  child_user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,

  name VARCHAR(100) NOT NULL, -- ì˜ˆ: "í‰ì¼ í•™ìŠµ ì‹œê°„"
  description TEXT,

  status schedule_status_enum DEFAULT 'ACTIVE',

  start_time TIME NOT NULL,
  end_time TIME NOT NULL,

  created_by UUID REFERENCES users(id), -- ë¶€ëª¨/êµì‚¬
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now(),

  CONSTRAINT chk_schedule_time
    CHECK (start_time < end_time)
);

-- ìë…€ë³„ ìŠ¤ì¼€ì¤„ ì¡°íšŒ
CREATE INDEX idx_child_schedules_child
  ON child_schedules(child_user_id);

-- í™œì„± ìŠ¤ì¼€ì¤„ í•„í„°
CREATE INDEX idx_child_schedules_status
  ON child_schedules(status);

--  ìŠ¤ì¼€ì¤„ ìš”ì¼ ë§¤í•‘ (260210)
CREATE TABLE child_schedule_days (
  schedule_id UUID NOT NULL
    REFERENCES child_schedules(id) ON DELETE CASCADE,

  day day_of_week_enum NOT NULL,

  PRIMARY KEY (schedule_id, day)
);

CREATE INDEX idx_schedule_days_day
  ON child_schedule_days(day);

-- QR / ë””ë°”ì´ìŠ¤ì™€ ìŠ¤ì¼€ì¤„ ì—°ê²° (260210)
CREATE TABLE device_schedule_links (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  device_id UUID NOT NULL REFERENCES devices(id) ON DELETE CASCADE,
  schedule_id UUID NOT NULL REFERENCES child_schedules(id) ON DELETE CASCADE,

  created_at TIMESTAMPTZ DEFAULT now(),

  CONSTRAINT uq_device_schedule UNIQUE (device_id, schedule_id)
);

CREATE INDEX idx_device_schedule_device
  ON device_schedule_links(device_id);

-- ì„œë²„ ê³µí†µ ì•± ì¹´í…Œê³ ë¦¬ ì •ì˜ (260212)
CREATE TABLE app_categories (
  id VARCHAR(50) PRIMARY KEY,       -- 'EDUCATION', 'GAMES' ë“± (Canonical ID)
  display_name VARCHAR(50) NOT NULL, -- UI í‘œì¶œìš© ëª…ì¹­ (ì˜ˆ: 'êµìœ¡', 'ê²Œì„')
  ios_category VARCHAR(100),         -- iOS ActivityCategory (ì˜ˆ: '.education')
  android_label VARCHAR(100),        -- Android ëŒ€ì‘ ë¼ë²¨ (ì˜ˆ: 'Education')
  updated_at TIMESTAMPTZ DEFAULT now()
);

-- updated_at ìë™ ê°±ì‹  íŠ¸ë¦¬ê±° ì—°ë™
CREATE TRIGGER trg_app_categories_updated_at
BEFORE UPDATE ON app_categories
FOR EACH ROW
EXECUTE FUNCTION set_updated_at();

-- ì•± ì¹´í…Œê³ ë¦¬ ë§¤í•‘ í…Œì´ë¸” (260212)
-- Android íŒ¨í‚¤ì§€ëª… ë˜ëŠ” iOS ë²ˆë“¤IDë¥¼ ê³µí†µ ì¹´í…Œê³ ë¦¬ë¡œ ë§¤í•‘
CREATE TABLE app_category_map (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  
  platform device_platform_enum NOT NULL,         -- 'ANDROID' ë˜ëŠ” 'IOS'
  package_name VARCHAR(255) NOT NULL,            -- íŒ¨í‚¤ì§€ëª…(Android) ë˜ëŠ” ë²ˆë“¤ì´ë¦„(iOS)
  app_name VARCHAR(100) NOT NULL,                 -- UI í‘œì¶œìš© ì•± ëª…ì¹­ (ì˜ˆ: 'ì¹´ì¹´ì˜¤í†¡', 'Google Classroom')
  category VARCHAR(50) NOT NULL 
    REFERENCES app_categories(id),                -- CANONICAL ì¹´í…Œê³ ë¦¬ ì°¸ì¡°
  
  updated_at TIMESTAMPTZ DEFAULT now(),
  
  CONSTRAINT uq_platform_package UNIQUE (platform, package_name)
);

-- updated_at ìë™ ê°±ì‹  íŠ¸ë¦¬ê±° ì—°ë™
CREATE TRIGGER trg_app_category_map_updated_at
BEFORE UPDATE ON app_category_map
FOR EACH ROW
EXECUTE FUNCTION set_updated_at();

-- ì¡°íšŒ ì¸ë±ìŠ¤
CREATE INDEX idx_app_category_platform_package 
  ON app_category_map(platform, package_name);

CREATE INDEX idx_app_category_name 
  ON app_category_map(category);

-- ê¸°ê¸° ì „ìš© ìŠ¤ì¼€ì¤„ (260210)
CREATE TABLE device_schedules (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  device_id UUID NOT NULL REFERENCES devices(id) ON DELETE CASCADE,

  name VARCHAR(100) NOT NULL,
  description TEXT,

  status schedule_status_enum DEFAULT 'ACTIVE',

  start_time TIME NOT NULL,
  end_time TIME NOT NULL,

  created_by UUID REFERENCES users(id),
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now(),

  CONSTRAINT chk_device_schedule_time
    CHECK (start_time < end_time)
);

CREATE INDEX idx_device_schedules_device
  ON device_schedules(device_id);

-- device_schedule ìš”ì¼ ë§¤ (260210)
CREATE TABLE device_schedule_days (
  schedule_id UUID NOT NULL
    REFERENCES device_schedules(id) ON DELETE CASCADE,

  day day_of_week_enum NOT NULL,

  PRIMARY KEY (schedule_id, day)
);

-- User í…Œì´ë¸” ì¬ì„¤ê³„ (260210)
DROP TYPE IF EXISTS auth_provider_enum CASCADE;

CREATE TYPE auth_provider_enum AS ENUM (
  'ANONYMOUS',  -- ê²ŒìŠ¤íŠ¸ (ê¸°ê¸° ê¸°ë°˜)
  'APPLE',
  'KAKAO',
  'EMAIL'
);

DROP TABLE IF EXISTS users CASCADE;

CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  -- ì¸ì¦ ìœ í˜•
  auth_provider auth_provider_enum NOT NULL,

  -- ì†Œì…œ ë¡œê·¸ì¸ ì‹ë³„ì
  apple_sub VARCHAR(255),
  kakao_user_id VARCHAR(50),

  -- ì—°ë½ì²˜ (ANONYMOUSì—ì„œëŠ” NULL í—ˆìš©)
  phone_number VARCHAR(20),
  email VARCHAR(255),

  display_name VARCHAR(50),

  status user_status_enum DEFAULT 'ACTIVE',

  -- ê²ŒìŠ¤íŠ¸ í”Œë˜ê·¸ (ì¿¼ë¦¬ ê°€ë…ì„±ìš©)
  is_guest BOOLEAN GENERATED ALWAYS AS (
    auth_provider = 'ANONYMOUS'
  ) STORED,

  -- ğŸ” ë³´ì•ˆ ë° ì œì–´ (260219 ì¶”ê°€)
  pin_code VARCHAR(6),                -- ë‚´ ì •ë³´ ì ‘ê·¼ìš© 6ìë¦¬ PIN
  restrict_my_info BOOLEAN DEFAULT FALSE, -- ë¶€ëª¨ì˜ ìë…€ í™”ë©´ ì ‘ê·¼ ì œí•œ í”Œë˜ê·¸

  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now(),

  -- ğŸ” ë¬´ê²°ì„± ì œì•½
  CONSTRAINT chk_social_identity
    CHECK (
      auth_provider = 'ANONYMOUS'
      OR apple_sub IS NOT NULL
      OR kakao_user_id IS NOT NULL
      OR email IS NOT NULL
    )
);

-- User Role Type í…Œì´ë¸” ì¶”ê°€ (260210)
DROP TYPE IF EXISTS role_type_enum CASCADE;


CREATE TYPE role_type_enum AS ENUM (
  -- ê°œì¸
  'PARENT',
  'CHILD',
  'TEACHER',

  -- ê¸°ê´€
  'ORG_ADMIN',
  'ORG_STAFF',

  -- ìš´ì˜
  'SERVICE_ADMIN',
  'TESTER'
);

-- User Role í…Œì´ë¸” ìƒì„± (260211 ìˆ˜ì •)
-- scope_idê°€ NULLì´ë©´ GLOBAL ê¶Œí•œìœ¼ë¡œ ê°„ì£¼í•©ë‹ˆë‹¤.
DROP TABLE IF EXISTS user_roles CASCADE;

CREATE TABLE user_roles (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  role role_type_enum NOT NULL,

  -- ğŸŒ ê¶Œí•œ ë²”ìœ„
  -- GLOBAL: ì „ì²´ ìœ íš¨ (SERVICE_ADMIN, TESTER ë“±)
  -- ORG: íŠ¹ì • ê¸°ê´€ í•œì • (ORG_ADMIN, TEACHER ë“±)
  -- CHILD: íŠ¹ì • ìë…€ í•œì • (PARENT ê´€ë¦¬ìš©)
  scope_type TEXT CHECK (scope_type IN ('GLOBAL', 'ORG', 'CHILD', 'CLASS')) DEFAULT 'GLOBAL',
  scope_id UUID, -- NULLì´ë©´ GLOBAL, ê·¸ì™¸ organization_id, child_user_id ë“±

  assigned_at TIMESTAMPTZ DEFAULT now(),

  -- ë™ì¼ ì‚¬ìš©ìê°€ ë™ì¼ ë²”ìœ„ ë‚´ì—ì„œ ë™ì¼ ì—­í• ì„ ì¤‘ë³µí•´ì„œ ê°€ì§€ì§€ ì•Šë„ë¡ ë³´ì¥
  CONSTRAINT uq_user_role_scope UNIQUE NULLS NOT DISTINCT (user_id, role, scope_id)
);

CREATE INDEX idx_user_roles_user_id ON user_roles(user_id);
CREATE INDEX idx_user_roles_scope ON user_roles(scope_type, scope_id);

-- ì•± ì ê¸ˆ/ì¶œì„ ê´€ë¦¬ preset ë§Œë“¤ê¸° (260210) 
-- Preset ì†Œìœ  ë²”ìœ„
CREATE TYPE preset_scope_enum AS ENUM (
  'SYSTEM',  -- ë½ëª¨ë¨¼íŠ¸ ì œê³µ
  'ORG',     -- ê¸°ê´€ ê³µìš©
  'USER'     -- ë¶€ëª¨/êµì‚¬ ê°œì¸
);

-- Preset ëª©ì  (í•µì‹¬)
CREATE TYPE preset_purpose_enum AS ENUM (
  'LOCK_ONLY',
  'ATTENDANCE_ONLY',
  'LOCK_AND_ATTENDANCE'
);

-- ì ê¸ˆ íƒ€ì…
CREATE TYPE lock_type_enum AS ENUM (
  'FULL',      -- ì „ì²´ ì ê¸ˆ
  'APP_ONLY'   -- ì•± ì ê¸ˆ
);

-- Preset ì ìš© ëŒ€ìƒ
CREATE TYPE preset_target_enum AS ENUM (
  'STUDENT',
  'DEVICE',
  'CLASS'
);

-- preset_policies í…Œì´ë¸”
CREATE TABLE preset_policies (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  -- SYSTEM / ORG / USER
  scope preset_scope_enum NOT NULL,

  -- SYSTEM = NULL
  -- ORG    = organization_id
  -- USER   = user_id
  owner_id UUID NULL,

  name VARCHAR(100) NOT NULL,
  description TEXT,

  -- ğŸ”‘ Preset ëª©ì  (ì ê¸ˆ / ì¶œì„ / ë‘˜ë‹¤)
  purpose preset_purpose_enum NOT NULL DEFAULT 'LOCK_AND_ATTENDANCE',

  -- ğŸ” ì ê¸ˆ ê´€ë ¨ (ATTENDANCE_ONLY ì—ì„œëŠ” NULL)
  lock_type lock_type_enum,
  allowed_categories JSONB,
  blocked_categories JSONB,
  allowed_apps JSONB,
  default_duration_minutes INT,

  is_active BOOLEAN DEFAULT TRUE,

  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now(),

  -- ğŸ”’ ì¶œì„ ì „ìš© preset ë¬´ê²°ì„± ë³´ì¥
  CONSTRAINT chk_attendance_only_preset
    CHECK (
      purpose <> 'ATTENDANCE_ONLY'
      OR (
        lock_type IS NULL
        AND allowed_categories IS NULL
        AND blocked_categories IS NULL
        AND allowed_apps IS NULL
        AND default_duration_minutes IS NULL
      )
    )
);

-- ì¸ë±ìŠ¤ 
-- scope + owner ê¸°ì¤€ ì¡°íšŒ (ê¸°ê´€/ìœ ì € preset ëª©ë¡)
CREATE INDEX idx_preset_policies_scope_owner
  ON preset_policies(scope, owner_id);

-- í™œì„± preset ë¹ ë¥¸ ì¡°íšŒ
CREATE INDEX idx_preset_policies_active
  ON preset_policies(is_active);

-- purpose í•„í„° (ì¶œì„ ì „ìš© / ì ê¸ˆ ì „ìš©)
CREATE INDEX idx_preset_policies_purpose
  ON preset_policies(purpose);


-- preset_usage í…Œì´ë¸” (260210)
CREATE TABLE preset_usage (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  preset_id UUID NOT NULL
    REFERENCES preset_policies(id)
    ON DELETE CASCADE,

  used_by UUID NOT NULL
    REFERENCES users(id),

  target_type preset_target_enum NOT NULL,
  target_id UUID NOT NULL,

  purpose preset_purpose_enum NOT NULL,

  -- ì ê¸ˆ presetì¼ ê²½ìš°ë§Œ ì—°ê²°
  applied_policy_id UUID
    REFERENCES lock_policies(id),

  applied_at TIMESTAMPTZ DEFAULT now()
);

CREATE INDEX idx_preset_usage_preset
  ON preset_usage(preset_id);

CREATE INDEX idx_preset_usage_used_by
  ON preset_usage(used_by);

CREATE INDEX idx_preset_usage_target
  ON preset_usage(target_type, target_id);

CREATE INDEX idx_preset_usage_applied_at
  ON preset_usage(applied_at);

-- ock_policies í…Œì´ë¸” 
DROP TABLE IF exists lock_policies CASCADE;

CREATE TABLE lock_policies (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  preset_id UUID
    REFERENCES preset_policies(id),

  purpose preset_purpose_enum NOT NULL DEFAULT 'LOCK_ONLY',

  lock_type lock_type_enum NOT NULL,
  allowed_categories JSONB,
  blocked_categories JSONB,
  allowed_apps JSONB,

  duration_minutes INT NOT NULL,
  
  -- ì˜ˆì•½ ì •ë³´
  time_window VARCHAR(50), -- ì˜ˆ: "09:00-10:00"
  days JSONB,              -- ì˜ˆ: ["ì›”", "í™”"]

  is_customized BOOLEAN DEFAULT FALSE,

  created_by UUID REFERENCES users(id),
  created_at TIMESTAMPTZ DEFAULT now()
);

-- QR Code ìˆ˜ì • í…Œì´ë¸” ë‹¤ì‹œ ìƒì„± (260214)
-- ê¸°ì¡´ íƒ€ì… ì‚­ì œ (ì •í•©ì„± ë³´ì¥)
DROP TYPE IF EXISTS qr_type_enum CASCADE;
DROP TYPE IF EXISTS qr_purpose_enum CASCADE;
DROP TYPE IF EXISTS qr_schedule_mode_enum CASCADE;
DROP TYPE IF EXISTS qr_target_type_enum CASCADE;
DROP TYPE IF EXISTS qr_status_enum CASCADE;

-- QR ê³ ì •/ë™ì 
CREATE TYPE qr_type_enum AS ENUM (
  'STATIC',     -- ê³ ì •í˜• (ë¶€ëª¨/ì¼ë°˜/ê¸°ê´€ ì¶œì„íŒ)
  'DYNAMIC'     -- 1íšŒì„±/ì„¸ì…˜ìš©
);

-- QR ëª©ì  (Preset purposeì™€ 1:1)
CREATE TYPE qr_purpose_enum AS ENUM (
  'ATTENDANCE_ONLY',
  'LOCK_ONLY',
  'LOCK_AND_ATTENDANCE'
);

-- QR ìŠ¤ì¼€ì¤„ ë°©ì‹
CREATE TYPE qr_schedule_mode_enum AS ENUM (
  'IMMEDIATE',
  'RESERVED'
);

-- QR ì ìš© ëŒ€ìƒ
CREATE TYPE qr_target_type_enum AS ENUM (
  'CLASS',
  'STUDENT',
  'DEVICE',
  'HOME'
);

-- QR ìƒíƒœ
CREATE TYPE qr_status_enum AS ENUM (
  'ACTIVE',
  'EXPIRED',
  'REVOKED'
);

-- QR ì½”ë“œ í…Œì´ë¸” (260214) hmac_sig, updated_at ì¶”ê°€
DROP TABLE IF EXISTS qr_device_usage CASCADE;
DROP TABLE IF EXISTS qr_codes CASCADE;

CREATE TABLE qr_codes (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  qr_type qr_type_enum NOT NULL,
  purpose qr_purpose_enum NOT NULL,
  preset_id UUID NULL REFERENCES preset_policies(id),
  lock_policy_id UUID NULL REFERENCES lock_policies(id),
  target_type qr_target_type_enum NOT NULL,
  target_id UUID NOT NULL,
  schedule_mode qr_schedule_mode_enum NOT NULL DEFAULT 'IMMEDIATE',
  valid_from TIMESTAMPTZ NULL,
  valid_to TIMESTAMPTZ NULL,
  one_time BOOLEAN DEFAULT FALSE,
  max_scan_count INT NULL,
  status qr_status_enum DEFAULT 'ACTIVE',
  hmac_sig VARCHAR(255),
  created_by UUID NOT NULL REFERENCES users(id),
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now(),
  CONSTRAINT chk_qr_valid_time CHECK (valid_from IS NULL OR valid_to IS NULL OR valid_from < valid_to)
);

CREATE TRIGGER trg_qr_codes_updated_at BEFORE UPDATE ON qr_codes FOR EACH ROW EXECUTE FUNCTION set_updated_at();

-- ğŸ“Œ ì‚¬ì „ ë“±ë¡(Preset) ê¸°ë³¸ ë°ì´í„° ì¶”ê°€ (UI í…ŒìŠ¤íŠ¸ ë° ì´ˆê¸° ì‚¬ìš©ìš©)
DELETE FROM preset_policies WHERE scope = 'SYSTEM';
INSERT INTO preset_policies (id, scope, name, description, purpose, lock_type, allowed_categories, blocked_categories, allowed_apps, default_duration_minutes)
VALUES 
  (gen_random_uuid(), 'SYSTEM', 'ìˆ˜ì—… ì§‘ì¤‘', 'í•™ìŠµ ì•±ë§Œ í—ˆìš©í•˜ê³  ë‚˜ë¨¸ì§€ëŠ” ì°¨ë‹¨í•©ë‹ˆë‹¤.', 'LOCK_ONLY', 'APP_ONLY', '["EDUCATION", "UTILITIES"]', '["GAMES", "SOCIAL", "ENTERTAINMENT"]', '[]', 60),
  (gen_random_uuid(), 'SYSTEM', 'ì‹œí—˜ ëª¨ë“œ', 'ëª¨ë“  ì•±ì„ ì°¨ë‹¨í•˜ì—¬ ì‹œí—˜ì—ë§Œ ì§‘ì¤‘í•©ë‹ˆë‹¤.', 'LOCK_ONLY', 'FULL', '[]', '[]', '[]', 120),
  (gen_random_uuid(), 'SYSTEM', 'ì·¨ì¹¨ ì‹œê°„', 'ë°¤ ëŠ¦ì€ ì‹œê°„ ìŠ¤ë§ˆíŠ¸í° ì‚¬ìš©ì„ ì œí•œí•©ë‹ˆë‹¤.', 'LOCK_ONLY', 'APP_ONLY', '["HEALTHVITALITY"]', '["GAMES", "SOCIAL", "ENTERTAINMENT"]', '[]', 480);

CREATE TABLE qr_device_usage (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  qr_id UUID NOT NULL REFERENCES qr_codes(id) ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES users(id),
  device_id UUID NOT NULL REFERENCES devices(id),
  attendance_recorded BOOLEAN DEFAULT FALSE,
  lock_applied BOOLEAN DEFAULT FALSE,
  failure_reason TEXT NULL,
  scanned_at TIMESTAMPTZ DEFAULT now(),
  CONSTRAINT uq_qr_device_once UNIQUE (qr_id, device_id)
);

---

## ğŸ›  users í…Œì´ë¸” ì¬ìƒì„± ë° ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜ ê°€ì´ë“œ

`users` í…Œì´ë¸”ì— `pin_code` ë° `restrict_my_info` ì»¬ëŸ¼ì„ ì ìš©í•˜ê¸° ìœ„í•´ í…Œì´ë¸”ì„ `DROP` í›„ ì¬ìƒì„±í•  ê²½ìš°, ì„œë¹„ìŠ¤ ìš´ì˜ ë° ë°ì´í„° ë¬´ê²°ì„±ì„ ìœ„í•´ ë‹¤ìŒ ì‚¬í•­ì„ ë°˜ë“œì‹œ ì¤€ìˆ˜í•´ì•¼ í•©ë‹ˆë‹¤.

### 1. ì‚¬ì „ ì¤€ë¹„ ì‘ì—… (Pre-requisites)
*   **ì „ì²´ ë°±ì—… (Full Backup)**: 
    *   `users` í…Œì´ë¸”ë¿ë§Œ ì•„ë‹ˆë¼ ì´ë¥¼ ì°¸ì¡°í•˜ëŠ” ëª¨ë“  í…Œì´ë¸”(`devices`, `user_roles`, `parent_child_relations`, `child_schedules` ë“±)ì˜ ë°ì´í„°ë¥¼ JSON ë˜ëŠ” CSV í˜•íƒœë¡œ ìµìŠ¤í¬íŠ¸í•©ë‹ˆë‹¤.
    *   íŠ¹íˆ ì‚¬ìš©ìì˜ **UUID (id)** ê°’ì€ ì¬ìƒì„± ì‹œì—ë„ ë™ì¼í•˜ê²Œ ìœ ì§€í•´ì•¼ ê¸°ì¡´ ê¸°ê¸° ë° ìŠ¤ì¼€ì¤„ ì—°ê²°ì´ ê¹¨ì§€ì§€ ì•ŠìŠµë‹ˆë‹¤.
*   **ì„œë¹„ìŠ¤ ì ê²€ ëª¨ë“œ**: í…Œì´ë¸” êµ¬ì¡° ë³€ê²½ ë° ë°ì´í„° ë³µêµ¬ ê³¼ì • ì¤‘ ë°ì´í„° ë¶ˆì¼ì¹˜ê°€ ë°œìƒí•˜ì§€ ì•Šë„ë¡ ì• í”Œë¦¬ì¼€ì´ì…˜ ì ‘ì†ì„ ì°¨ë‹¨í•©ë‹ˆë‹¤.

### 2. ë°ì´í„° ì‚­ì œ ë° ìˆœì„œ (Deletion Order)
`users` í…Œì´ë¸”ì€ ì‹œìŠ¤í…œì˜ í•µì‹¬ í…Œì´ë¸”ë¡œ, ë§ì€ í…Œì´ë¸”ì´ ì´ë¥¼ ì™¸ë˜ í‚¤(FK)ë¡œ ì°¸ì¡°í•˜ê³  ìˆìŠµë‹ˆë‹¤. `CASCADE` ì˜µì…˜ì„ ì‚¬ìš©í•˜ë©´ ì—°ê´€ ë°ì´í„°ê°€ í•¨ê»˜ ì‚­ì œë˜ë¯€ë¡œ ì£¼ì˜í•´ì•¼ í•©ë‹ˆë‹¤.

**ëª…ì‹œì  ì‚­ì œ ìˆœì„œ (FK ì œì•½ ì¡°ê±´ ê³ ë ¤):**
1.  `qr_device_usage` (ì‚¬ìš© ê¸°ë¡)
2.  `qr_codes` (ìƒì„±ëœ QR)
3.  `lock_policies` (ì ê¸ˆ ì •ì±…)
4.  `preset_usage` (í”„ë¦¬ì…‹ ì‚¬ìš© ê¸°ë¡)
5.  `device_schedules` / `child_schedules` (ìŠ¤ì¼€ì¤„ ë°ì´í„°)
6.  `parent_child_relations` (ë¶€ëª¨-ìë…€ ì—°ê²°)
7.  `devices` (ê¸°ê¸° ì •ë³´)
8.  `user_roles` (ê¶Œí•œ ì •ë³´)
9.  `users` (ì‚¬ìš©ì í•µì‹¬ í…Œì´ë¸”)

### 3. í…Œì´ë¸” ì¬ìƒì„± ë° ë³µêµ¬ ì ˆì°¨
1.  **í…Œì´ë¸” ì‚­ì œ**: `DROP TABLE users CASCADE;` (ì—°ê´€ëœ ëª¨ë“  ì œì•½ ì¡°ê±´ê³¼ í•¨ê»˜ ì‚­ì œ)
2.  **í…Œì´ë¸” ìƒì„±**: ë³¸ ë¬¸ì„œì˜ ìµœì‹  `users` í…Œì´ë¸” ì •ì˜(`pin_code`, `restrict_my_info` í¬í•¨)ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.
3.  **ë°ì´í„° ë³µêµ¬ (Migration)**:
    *   ë°±ì—…í•´ë‘” ê¸°ì¡´ ì‚¬ìš©ì ë°ì´í„°ë¥¼ `INSERT` í•©ë‹ˆë‹¤. ì´ë•Œ ê¸°ì¡´ì˜ `id` (UUID) ê°’ì„ ëª…ì‹œì ìœ¼ë¡œ ì‚½ì…í•´ì•¼ í•©ë‹ˆë‹¤.
    *   ìƒˆë¡œ ì¶”ê°€ëœ ì»¬ëŸ¼(`pin_code`, `restrict_my_info`)ì€ ê¸°ë³¸ê°’(NULL ë˜ëŠ” FALSE)ìœ¼ë¡œ ì±„ì›Œì§‘ë‹ˆë‹¤.
4.  **ì°¸ì¡° í…Œì´ë¸” ë³µêµ¬**: `devices`, `user_roles` ë“± ë°±ì—…ëœ ì—°ê´€ í…Œì´ë¸” ë°ì´í„°ë¥¼ ì°¨ë¡€ëŒ€ë¡œ ë³µêµ¬í•©ë‹ˆë‹¤.

### 4. ì£¼ì˜ì‚¬í•­
*   **JWT í† í°**: `users` í…Œì´ë¸”ì´ ì¬ìƒì„±ë˜ë©´ ê¸°ì¡´ì— ë°œê¸‰ëœ JWT í† í°ì˜ `sub` (user_id) ê°’ì´ ìœ íš¨í•˜ë”ë¼ë„, DB êµ¬ì¡° ë³€ê²½ ì˜í–¥ìœ¼ë¡œ ì¸í•´ ëª¨ë“  ì‚¬ìš©ìì˜ **ê°•ì œ ë¡œê·¸ì•„ì›ƒ** ë° ì¬ë¡œê·¸ì¸ì´ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
*   **ì¸ë±ìŠ¤ ë° íŠ¸ë¦¬ê±°**: í…Œì´ë¸”ì„ `DROP` í•˜ë©´ ì—°ê²°ëœ íŠ¸ë¦¬ê±°(`set_updated_at`)ì™€ ì¸ë±ìŠ¤ë„ ëª¨ë‘ ì‚­ì œë˜ë¯€ë¡œ ë°˜ë“œì‹œ ë‹¤ì‹œ ìƒì„±í•´ì•¼ í•©ë‹ˆë‹¤.