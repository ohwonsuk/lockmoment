## Devices í…Œì´ë¸” ìƒˆë¡œ ìƒì„± (260210)

 ì§€ê¸ˆ ë‹¨ê³„ë©´ **devices í…Œì´ë¸”ì„ ê³¼ê°í•˜ê²Œ ì¬ì„¤ê³„í•˜ëŠ” ê²Œ ì •ë‹µ**ì´ì•¼ ğŸ‘  
ì•„ë˜ëŠ” **PostgreSQL ê¸°ì¤€**,

- ê¸°ì¡´ í…Œì´ë¸” **DROP â†’ ì‹ ê·œ CREATE**
- **ê¶Œí•œ ìƒíƒœ ì¶”ì **
- **í”Œë«í¼ ì°¨ì´(iOS / Android) ë°˜ì˜**
- **í–¥í›„ í™•ì¥(ê¶Œí•œ ì„¸ë¶„í™”, ë™ê¸°í™” ì‹œì , ì •ì±… ì ìš© ì´ë ¥)**  
    ê¹Œì§€ ê³ ë ¤í•´ì„œ ì •ë¦¬í•œ **ê¶Œì¥ ìŠ¤í‚¤ë§ˆ + ì‘ì—… ìˆœì„œ**ì•¼.

---

# âœ… ì „ì²´ ë°©í–¥ ìš”ì•½

- `permission_status JSONB` âŒ â†’ **ì‚­ì œ**
- ê¶Œí•œ ìƒíƒœëŠ” **ëª…ì‹œì  ì»¬ëŸ¼(Boolean + enum)** ìœ¼ë¡œ ê´€ë¦¬
- iOS / Android ê³µí†µ + í”Œë«í¼ë³„ ê¶Œí•œ ë¶„ë¦¬
- ë¶€ëª¨/êµì‚¬ í™”ë©´ì—ì„œ **ê¶Œí•œ ìƒíƒœ ì¦‰ì‹œ íŒë‹¨ ê°€ëŠ¥**
- ì¸ë±ìŠ¤, enum, ì œì•½ì¡°ê±´ê¹Œì§€ í¬í•¨

---

# 1ï¸âƒ£ ENUM ì •ì˜ (ë¨¼ì € ì‹¤í–‰)

```sql
-- ë””ë°”ì´ìŠ¤ í”Œë«í¼
CREATE TYPE device_platform_enum AS ENUM ('IOS', 'ANDROID');

-- ë””ë°”ì´ìŠ¤ ìƒíƒœ
CREATE TYPE device_status_enum AS ENUM ('ACTIVE', 'INACTIVE', 'REVOKED');

-- ê¶Œí•œ ìƒíƒœ (ë‹¨ìˆœ Booleanë³´ë‹¤ í™•ì¥ì„± í™•ë³´)
CREATE TYPE permission_state_enum AS ENUM (
  'GRANTED',
  'DENIED',
  'NOT_DETERMINED'
);
```

> ğŸ’¡ ì´ìœ 
> 
> - iOSëŠ” `NOT_DETERMINED` ìƒíƒœê°€ ë§¤ìš° ì¤‘ìš”
> - Booleanë§Œ ì“°ë©´ UX íŒë‹¨ì´ ì–´ë ¤ì›€
>     

---

# 2ï¸âƒ£ ê¸°ì¡´ devices í…Œì´ë¸” ì‚­ì œ

```sql
DROP TABLE IF EXISTS devices CASCADE;
```

> âš ï¸ CASCADE ì‚¬ìš© ì´ìœ 
> 
> - lock_history, attendance ë“± FK ì—°ê´€ ê°€ëŠ¥ì„± ê³ ë ¤
>     

---

# 3ï¸âƒ£ devices í…Œì´ë¸” ì‹ ê·œ ìƒì„± (ê¶Œì¥ì•ˆ)

```sql
CREATE TABLE devices (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,

  platform device_platform_enum NOT NULL,

  -- ë””ë°”ì´ìŠ¤ ì‹ë³„
  device_uuid VARCHAR(255) NOT NULL UNIQUE,
  device_model VARCHAR(100),
  os_version VARCHAR(20),
  app_version VARCHAR(20),

  -- ğŸ” ê¶Œí•œ ìƒíƒœ (í•µì‹¬)
  accessibility_permission permission_state_enum, -- Android ì ‘ê·¼ì„± / iOS í•´ë‹¹ ì—†ìŒ
  screen_time_permission permission_state_enum,   -- iOS Family Controls
  notification_permission permission_state_enum,

  -- ê¶Œí•œ ë™ê¸°í™” ì‹œì 
  last_permission_sync TIMESTAMPTZ,

  -- ìƒíƒœ ê´€ë¦¬
  status device_status_enum DEFAULT 'ACTIVE',
  is_active BOOLEAN DEFAULT TRUE,

  -- ì ‘ì† ì •ë³´
  last_seen_at TIMESTAMPTZ,

  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now(),

  -- í”Œë«í¼ë³„ ê¶Œí•œ ì œì•½ (ì„ íƒ)
  CONSTRAINT chk_ios_permissions
    CHECK (
      platform <> 'IOS'
      OR accessibility_permission IS NULL
    )
);
```

---

# 4ï¸âƒ£ ì¸ë±ìŠ¤ ì„¤ì • (í•„ìˆ˜)

```sql
-- ì‚¬ìš©ì â†’ ë””ë°”ì´ìŠ¤ ì¡°íšŒ (ë¶€ëª¨/êµì‚¬ í™”ë©´ í•µì‹¬)
CREATE INDEX idx_devices_user_id
  ON devices(user_id);

-- í™œì„± ë””ë°”ì´ìŠ¤ í•„í„°ë§
CREATE INDEX idx_devices_active
  ON devices(is_active)
  WHERE is_active = TRUE;

-- ìµœê·¼ ì ‘ì† ê¸°ì¤€
CREATE INDEX idx_devices_last_seen
  ON devices(last_seen_at DESC);

-- ê¶Œí•œ ìƒíƒœ ëª¨ë‹ˆí„°ë§ (ìš´ì˜/ì•Œë¦¼ìš©)
CREATE INDEX idx_devices_permission_sync
  ON devices(last_permission_sync);
```

---

# 5ï¸âƒ£ updated_at ìë™ ê°±ì‹  íŠ¸ë¦¬ê±° (ê¶Œì¥)

```sql
CREATE OR REPLACE FUNCTION set_updated_at()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = now();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_devices_updated_at
BEFORE UPDATE ON devices
FOR EACH ROW
EXECUTE FUNCTION set_updated_at();
```

---

# 6ï¸âƒ£ ê¶Œí•œ ìƒíƒœ ì—…ë°ì´íŠ¸ ì˜ˆì‹œ (í´ë¼ì´ì–¸íŠ¸ â†’ ì„œë²„)

### iOS (Family Controls)

```sql
UPDATE devices
SET
  screen_time_permission = 'GRANTED',
  notification_permission = 'GRANTED',
  last_permission_sync = now()
WHERE device_uuid = :device_uuid;
```

### Android (Accessibility + App Lock)

```sql
UPDATE devices
SET
  accessibility_permission = 'GRANTED',
  notification_permission = 'GRANTED',
  last_permission_sync = now()
WHERE device_uuid = :device_uuid;
```

---

# 7ï¸âƒ£ ë¶€ëª¨/êµì‚¬ ìë…€ ëª©ë¡ ì¡°íšŒìš© ì˜ˆì‹œ ì¿¼ë¦¬

```sql
SELECT
  u.id AS child_id,
  u.name,
  d.platform,
  d.accessibility_permission,
  d.screen_time_permission,
  d.notification_permission,
  d.last_permission_sync
FROM users u
JOIN devices d ON d.user_id = u.id
WHERE u.user_type = 'STUDENT'
  AND d.is_active = TRUE;
```

ğŸ‘‰ **UX í¬ì¸íŠ¸**

- âŒ â€œì ê¸ˆ ì•ˆë¨â€
- âœ… â€œê¶Œí•œ ë¯¸ì„¤ì •â€
- âœ… â€œê¶Œí•œ ê±°ë¶€ë¨â€
- âœ… â€œì •ìƒ ì ìš© ì¤‘â€

ì„ ëª…í™•íˆ êµ¬ë¶„ ê°€ëŠ¥

---

# 8ï¸âƒ£ ì™œ ì´ êµ¬ì¡°ê°€ ì¢‹ì€ê°€

|í•­ëª©|ì´ìœ |
|---|---|
|JSONB ì œê±°|API/UX íŒë‹¨ ë¡œì§ ë‹¨ìˆœí™”|
|permission_state_enum|iOS ì‹¬ì‚¬ ëŒ€ì‘ + UX ì •í™•ë„|
|platform ì œì•½|ì˜ëª»ëœ ê¶Œí•œ ì €ì¥ ë°©ì§€|
|last_permission_sync|â€œê¶Œí•œ ì„¤ì •í•˜ì…¨ë‚˜ìš”?â€ ì•Œë¦¼ ê·¼ê±°|
|device_uuid unique|QRÂ·ì ê¸ˆÂ·ì¶œì„ì˜ ê¸°ì¤€ í‚¤|

---

# ë‹¤ìŒìœ¼ë¡œ ì´ì–´ì„œ í•˜ë©´ ì¢‹ì€ ê²ƒ ğŸ”œ

1. âœ… **ë¶€ëª¨-ìë…€ ìŠ¤ì¼€ì¤„ í…Œì´ë¸” ì„¤ê³„**
    
2. âœ… **QR ìƒì„± ì‹œ ìŠ¤ì¼€ì¤„ ì €ì¥ êµ¬ì¡°**
    
3. âœ… **ê¶Œí•œ ë¯¸ì„¤ì • ì‹œ ì ê¸ˆ ì°¨ë‹¨ ë¡œì§**
    
4. âœ… **RLSë¡œ ë¶€ëª¨ëŠ” ìë…€ ë””ë°”ì´ìŠ¤ë§Œ ì¡°íšŒ**
    

ì›í•˜ë©´ ë‹¤ìŒ ë‹¨ê³„ ë°”ë¡œ ì´ì–´ì„œ  
ğŸ‘‰ **â€œë¶€ëª¨-ìë…€ ìŠ¤ì¼€ì¤„ + QR ìŠ¤ì¼€ì¤„ í…Œì´ë¸” ì„¤ê³„â€** ì •ë¦¬í•´ì¤„ê²Œ.


ì¢‹ì•„, ì§€ê¸ˆ êµ¬ì¡° íë¦„(ë¶€ëª¨â€“ìë…€â€“ë””ë°”ì´ìŠ¤â€“ê¶Œí•œâ€“ìŠ¤ì¼€ì¤„)ì´ ëª…í™•í•´ì„œ **í•œ ë²ˆì— ê¹”ë”í•˜ê²Œ ë‹¤ì‹œ ì„¤ê³„**í•˜ëŠ” ê²Œ ë§ì•„ ğŸ‘  
ì•„ë˜ëŠ” **ë¶€ëª¨â€“ìë…€ ìŠ¤ì¼€ì¤„ ê´€ë¦¬ì— ìµœì í™”ëœ í…Œì´ë¸” ì„¤ê³„ì•ˆ**ì´ì•¼.  
ğŸ‘‰ _ê¸°ì¡´ í…Œì´ë¸” DROP í›„ ì‹ ê·œ ìƒì„±_, **enum / index / í™•ì¥ì„±**ê¹Œì§€ ë‹¤ ë°˜ì˜í–ˆì–´.

---

# ğŸ§© ì„¤ê³„ ì „ì œ (ëª…í™•íˆ ì§šê³  ê°€ì)

### í•µì‹¬ ìš”êµ¬

- ë¶€ëª¨ â†” ìë…€ **N:M ê´€ê³„** ê°€ëŠ¥
- ìë…€ë³„ **ì—¬ëŸ¬ ìŠ¤ì¼€ì¤„** ê´€ë¦¬
- ìŠ¤ì¼€ì¤„ì€ **ìš”ì¼/ì‹œê°„ ê¸°ë°˜**
- QR ìƒì„± ì‹œ **ìŠ¤ì¼€ì¤„ ì—°ê²° ê°€ëŠ¥**
- ê¶Œí•œ ìƒíƒœ íŒë‹¨ì— ë°”ë¡œ ì“°ì¼ ìˆ˜ ìˆì–´ì•¼ í•¨

---

# 1ï¸âƒ£ ENUM ì •ì˜ (ë¨¼ì € ìƒì„±)

```sql
-- ìš”ì¼ enum
CREATE TYPE day_of_week_enum AS ENUM (
  'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT', 'SUN'
);

-- ìŠ¤ì¼€ì¤„ ìƒíƒœ
CREATE TYPE schedule_status_enum AS ENUM (
  'ACTIVE',
  'PAUSED',
  'DELETED'
);
```

---

# 2ï¸âƒ£ ë¶€ëª¨â€“ìë…€ ê´€ê³„ í…Œì´ë¸”

```sql
DROP TABLE IF EXISTS parent_child_relations CASCADE;

CREATE TABLE parent_child_relations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  parent_user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  child_user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,

  is_primary BOOLEAN DEFAULT FALSE, -- ì£¼ ë³´í˜¸ì ì—¬ë¶€
  created_at TIMESTAMPTZ DEFAULT now(),

  CONSTRAINT uq_parent_child UNIQUE (parent_user_id, child_user_id)
);

-- ì¡°íšŒ ìµœì í™”
CREATE INDEX idx_parent_child_parent
  ON parent_child_relations(parent_user_id);

CREATE INDEX idx_parent_child_child
  ON parent_child_relations(child_user_id);
```

ğŸ“Œ **í¬ì¸íŠ¸**

- ë¶€ëª¨ 2ëª… ì´ìƒ ê°€ëŠ¥
- ì£¼ ë³´í˜¸ì(primary) êµ¬ë¶„ ê°€ëŠ¥
- ì¶”í›„ êµì‚¬/ê¸°ê´€ë„ í™•ì¥ ê°€ëŠ¥

---

# 3ï¸âƒ£ ìë…€ ìŠ¤ì¼€ì¤„ í…Œì´ë¸” (í•µì‹¬)

```sql
DROP TABLE IF EXISTS child_schedules CASCADE;

CREATE TABLE child_schedules (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  child_user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,

  name VARCHAR(100) NOT NULL, -- ì˜ˆ: "í‰ì¼ í•™ìŠµ ì‹œê°„"
  description TEXT,

  status schedule_status_enum DEFAULT 'ACTIVE',

  start_time TIME NOT NULL,
  end_time TIME NOT NULL,

  created_by UUID REFERENCES users(id), -- ë¶€ëª¨/êµì‚¬
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now(),

  CONSTRAINT chk_schedule_time
    CHECK (start_time < end_time)
);

-- ìë…€ë³„ ìŠ¤ì¼€ì¤„ ì¡°íšŒ
CREATE INDEX idx_child_schedules_child
  ON child_schedules(child_user_id);

-- í™œì„± ìŠ¤ì¼€ì¤„ í•„í„°
CREATE INDEX idx_child_schedules_status
  ON child_schedules(status);
```

---

# 4ï¸âƒ£ ìŠ¤ì¼€ì¤„ ìš”ì¼ ë§¤í•‘ (ì •ê·œí™”)

```sql
DROP TABLE IF EXISTS child_schedule_days CASCADE;

CREATE TABLE child_schedule_days (
  schedule_id UUID NOT NULL
    REFERENCES child_schedules(id) ON DELETE CASCADE,

  day day_of_week_enum NOT NULL,

  PRIMARY KEY (schedule_id, day)
);

CREATE INDEX idx_schedule_days_day
  ON child_schedule_days(day);
```

ğŸ“Œ ì´ êµ¬ì¡° ë•ë¶„ì—:

- â€œì›”Â·ìˆ˜Â·ê¸ˆë§Œ ì ìš©â€
- â€œì£¼ë§ë§Œ ì°¨ë‹¨â€  
    ê°™ì€ ì •ì±…ì´ ì•„ì£¼ ì‰¬ì›Œì§

---

# 5ï¸âƒ£ (ì„ íƒ) QR / ë””ë°”ì´ìŠ¤ì™€ ìŠ¤ì¼€ì¤„ ì—°ê²°

QR ìƒì„± ì‹œ ìŠ¤ì¼€ì¤„ ì €ì¥ ìš”êµ¬ì‚¬í•­ ë°˜ì˜ ğŸ‘‡

```sql
DROP TABLE IF EXISTS device_schedule_links CASCADE;

CREATE TABLE device_schedule_links (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  device_id UUID NOT NULL REFERENCES devices(id) ON DELETE CASCADE,
  schedule_id UUID NOT NULL REFERENCES child_schedules(id) ON DELETE CASCADE,

  created_at TIMESTAMPTZ DEFAULT now(),

  CONSTRAINT uq_device_schedule UNIQUE (device_id, schedule_id)
);

CREATE INDEX idx_device_schedule_device
  ON device_schedule_links(device_id);
```

---

# ğŸ” ì‹¤ë¬´ì—ì„œ ë°”ë¡œ ì“°ëŠ” ì¡°íšŒ ì˜ˆì‹œ

### âœ… ìë…€ ëª©ë¡ + í˜„ì¬ ì ìš© ìŠ¤ì¼€ì¤„

```sql
SELECT
  c.id AS child_id,
  c.name,
  s.id AS schedule_id,
  s.name AS schedule_name,
  s.start_time,
  s.end_time
FROM users c
JOIN parent_child_relations pcr
  ON pcr.child_user_id = c.id
LEFT JOIN child_schedules s
  ON s.child_user_id = c.id
 AND s.status = 'ACTIVE'
WHERE pcr.parent_user_id = :parentId;
```

---

# ğŸ§  ì´ ì„¤ê³„ì˜ ê°•ì 

âœ… ë¶€ëª¨Â·êµì‚¬ ê³µí†µ ì‚¬ìš© ê°€ëŠ¥  
âœ… ìŠ¤ì¼€ì¤„ ì •ì±… ë³€ê²½ ì‰¬ì›€  
âœ… ì•± ì‹¬ì‚¬(ë³´í˜¸ì í†µì œ) ì„¤ëª… êµ¬ì¡° ëª…í™•  
âœ… ê¶Œí•œ íŒë‹¨ ë¡œì§ ë‹¨ìˆœí™”  
âœ… ê¸°ê´€/êµì‚¬ ìŠ¤ì¼€ì¤„ í™•ì¥ ê°€ëŠ¥

---

ì•„ì£¼ ì¢‹ì€ í¬ì¸íŠ¸ ì§šì—ˆì–´ ğŸ‘  
**â€œìë…€ 1ëª… = ì—¬ëŸ¬ ê¸°ê¸°(í° + íƒœë¸”ë¦¿ + ë³´ì¡°í° ë“±)â€** ì´ ì „ì œëŠ” ì§€ê¸ˆ êµ¬ì¡°ì—ì„œë„ _ê±°ì˜_ ë§ì§€ë§Œ, **ì±…ì„ ì£¼ì²´(ìë…€ ê¸°ì¤€)ì™€ ì •ì±… ì ìš© ë‹¨ìœ„(ê¸°ê¸° ê¸°ì¤€)**ë¥¼ ë” ëª…í™•íˆ ë‚˜ëˆ„ëŠ” ê²Œ ì¢‹ì•„.

ì•„ë˜ì—ì„œ  
1ï¸âƒ£ **í˜„ì¬ ì„¤ê³„ì—ì„œ ì´ë¯¸ ì¶©ì¡±ë˜ëŠ” ë¶€ë¶„**  
2ï¸âƒ£ **ë¶€ì¡±í•œ ë¶€ë¶„ / ê°œì„  í¬ì¸íŠ¸**  
3ï¸âƒ£ **ìˆ˜ì •ëœ ìµœì¢… ê¶Œì¥ í…Œì´ë¸” êµ¬ì¡°**  
ìˆœì„œë¡œ ì •ë¦¬í• ê²Œ.

---

## 1ï¸âƒ£ í˜„ì¬ ì„¤ê³„ì—ì„œ ì´ë¯¸ OKì¸ ë¶€ë¶„

### âœ… 1ëª… ìë…€ â†’ ì—¬ëŸ¬ ê¸°ê¸°

ì´ë¯¸ `devices` í…Œì´ë¸”ì´ ì´ë ‡ê²Œ ë˜ì–´ ìˆì§€?

```sql
devices.user_id â†’ users.id
```

ğŸ‘‰ ì¦‰,

- ìë…€(user) 1ëª…
- devices ì—¬ëŸ¬ row  
    â¡ **1:N êµ¬ì¡° ì´ë¯¸ ì¶©ì¡±**

ğŸ‘ ì´ ë¶€ë¶„ì€ êµ¬ì¡°ì ìœ¼ë¡œ ë¬¸ì œ ì—†ìŒ.

---

## 2ï¸âƒ£ ë‹¤ë§Œ, ì‹¤ì„œë¹„ìŠ¤ ê¸°ì¤€ì—ì„œ ì•„ì‰¬ìš´ ì 

### â— ë¬¸ì œ 1: ìŠ¤ì¼€ì¤„ ì ìš© ê¸°ì¤€ì´ ì• ë§¤í•¨

í˜„ì¬ êµ¬ì¡°ëŠ”:
- `child_schedules` â†’ **ìë…€ ê¸°ì¤€**
- `device_schedule_links` â†’ **ê¸°ê¸° â†” ìŠ¤ì¼€ì¤„ ì§ì ‘ ì—°ê²° (ì„ íƒ)**

ì´ëŸ¬ë©´ ì •ì±…ì´ í—·ê°ˆë¦´ ìˆ˜ ìˆì–´ ğŸ‘‡

|ìƒí™©|í•´ì„|
|---|---|
|ìë…€ Aê°€ í° + íƒœë¸”ë¦¿ ì‚¬ìš©|ê¸°ë³¸ ìŠ¤ì¼€ì¤„ì€ ë™ì¼|
|íƒœë¸”ë¦¿ë§Œ í•™ìŠµìš©|íƒœë¸”ë¦¿ë§Œ ì˜ˆì™¸ ìŠ¤ì¼€ì¤„ í•„ìš”|
|QR ë“±ë¡ ì‹œ|â€œì´ ê¸°ê¸°ëŠ” ì–´ë–¤ ìŠ¤ì¼€ì¤„ì„ ë”°ë¥´ë‚˜?â€|

ğŸ‘‰ ê·¸ë˜ì„œ **â€œê¸°ë³¸ì€ ìë…€ ìŠ¤ì¼€ì¤„ / ì˜ˆì™¸ëŠ” ê¸°ê¸° ì˜¤ë²„ë¼ì´ë“œâ€** êµ¬ì¡°ê°€ ê°€ì¥ ì•ˆì •ì ì´ì•¼.

---

## 3ï¸âƒ£ ê¶Œì¥ ì„¤ê³„ ì›ì¹™ (ì •ë¦¬)

### ğŸ¯ ì •ì±… ì ìš© ìš°ì„ ìˆœìœ„

```
ê¸°ê¸° ì „ìš© ìŠ¤ì¼€ì¤„ (ìˆìœ¼ë©´)
â†’ ì—†ìœ¼ë©´ ìë…€ ê¸°ë³¸ ìŠ¤ì¼€ì¤„
```

ì´ë¥¼ ìœ„í•´ í•„ìš”í•œ êµ¬ì¡°ëŠ”:

- ìë…€ ê¸°ì¤€ ê¸°ë³¸ ìŠ¤ì¼€ì¤„
- ê¸°ê¸° ê¸°ì¤€ ì„ íƒ/ì˜¤ë²„ë¼ì´ë“œ ìŠ¤ì¼€ì¤„
- ëª…í™•í•œ FK ê´€ê³„

---

## 4ï¸âƒ£ ìˆ˜ì • / ë³´ì™„ëœ ìµœì¢… í…Œì´ë¸” êµ¬ì¡°

### âœ… 1. devices (ë³€ê²½ ì—†ìŒ, ë‹¤ë§Œ ì˜ë¯¸ ëª…í™•í™”)

```sql
-- user_id = ìë…€ or í•™ìƒ
devices.user_id â†’ users.id
```

ğŸ“Œ ì£¼ì„ë§Œ ëª…í™•íˆ í•˜ë©´ ì¶©ë¶„

```sql
-- user_id: ì‹¤ì œ ê¸°ê¸° ì‚¬ìš©ì (ìë…€/í•™ìƒ)
```

---

### âœ… 2. child_schedules (ê¸°ë³¸ ìŠ¤ì¼€ì¤„, ìœ ì§€)

```sql
child_schedules.child_user_id â†’ users.id
```

ğŸ‘‰ ì˜ë¯¸:

- â€œì´ ìë…€ì—ê²Œ ê¸°ë³¸ì ìœ¼ë¡œ ì ìš©ë˜ëŠ” ì‹œê°„ ì •ì±…â€

âœ” ì—¬ëŸ¬ ê°œ ê°€ëŠ¥  
âœ” ìš”ì¼ë³„ ê°€ëŠ¥

---

### ğŸ”¥ 3. device_schedules (ê¸°ê¸° ì „ìš© ìŠ¤ì¼€ì¤„ â€“ í•µì‹¬ ì¶”ê°€)

> **ê¸°ê¸°ë§ˆë‹¤ ë‹¤ë¥¸ ì •ì±…ì„ ì£¼ê³  ì‹¶ì„ ë•Œ**

```sql
DROP TABLE IF EXISTS device_schedules CASCADE;

CREATE TABLE device_schedules (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  device_id UUID NOT NULL REFERENCES devices(id) ON DELETE CASCADE,

  name VARCHAR(100) NOT NULL,
  description TEXT,

  status schedule_status_enum DEFAULT 'ACTIVE',

  start_time TIME NOT NULL,
  end_time TIME NOT NULL,

  created_by UUID REFERENCES users(id),
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now(),

  CONSTRAINT chk_device_schedule_time
    CHECK (start_time < end_time)
);

CREATE INDEX idx_device_schedules_device
  ON device_schedules(device_id);
```

---

### âœ… 4. device_schedule_days (ìš”ì¼ ë§¤í•‘)

```sql
DROP TABLE IF EXISTS device_schedule_days CASCADE;

CREATE TABLE device_schedule_days (
  schedule_id UUID NOT NULL
    REFERENCES device_schedules(id) ON DELETE CASCADE,

  day day_of_week_enum NOT NULL,

  PRIMARY KEY (schedule_id, day)
);
```

---

## 5ï¸âƒ£ ìŠ¤ì¼€ì¤„ ì ìš© íŒë‹¨ ë¡œì§ (ì•„ì£¼ ì¤‘ìš”)

### ğŸ“Œ â€œì´ ê¸°ê¸° ì§€ê¸ˆ ì‚¬ìš© ê°€ëŠ¥?â€ íŒë‹¨ ìˆœì„œ

```text
1ï¸âƒ£ device_schedules ì¡´ì¬?
   â†’ YES: device ê¸°ì¤€ìœ¼ë¡œ íŒë‹¨
   â†’ NO : child_schedules ê¸°ì¤€ìœ¼ë¡œ íŒë‹¨
```

### ì˜ˆì‹œ SQL ê°œë…

```sql
-- device ì „ìš© ìŠ¤ì¼€ì¤„ ì¡´ì¬ ì—¬ë¶€
SELECT 1
FROM device_schedules
WHERE device_id = :deviceId
  AND status = 'ACTIVE'
LIMIT 1;
```

---

## 6ï¸âƒ£ ì´ë ‡ê²Œ ì„¤ê³„í•˜ë©´ ì–»ëŠ” ì´ì 

âœ… ìë…€ 1ëª… â†’ ì—¬ëŸ¬ ê¸°ê¸° ì™„ë²½ ëŒ€ì‘  
âœ… íƒœë¸”ë¦¿ë§Œ í•™ìŠµìš© / í°ì€ ì œí•œì  ì‚¬ìš© ê°€ëŠ¥  
âœ… QR ë“±ë¡ ì‹œ â€œê¸°ê¸° ì •ì±…â€ ëª…í™•  
âœ… iOS/Android ê¶Œí•œ êµ¬ì¡° ì„¤ëª… ì‰¬ì›€  
âœ… êµì‚¬/í•™êµ ì •ì±… í™•ì¥ ê°€ëŠ¥

---

## 7ï¸âƒ£ êµ¬ì¡° ìš”ì•½ (í•œ ëˆˆì—)

```
users (ë¶€ëª¨ / ìë…€ / êµì‚¬)
 â””â”€ parent_child_relations

users (ìë…€)
 â”œâ”€ child_schedules (ê¸°ë³¸)
 â”‚   â””â”€ child_schedule_days
 â””â”€ devices (Nê°œ)
     â””â”€ device_schedules (ì„ íƒ)
         â””â”€ device_schedule_days
```

---



**ANONYMOUS ì œê±° âŒ / ìœ ì§€ + ëª…í™•í•œ ë¶„ë¦¬ ì„¤ê³„ â­•ï¸**ê°€ ì •ë‹µì´ì•¼.  
ì§€ê¸ˆ ì„¤ëª…í•´ì¤€ ìš”êµ¬ì‚¬í•­ì€ **â€œê²ŒìŠ¤íŠ¸ì§€ë§Œ ì„œë²„ì—ì„œëŠ” ì—„ì—°í•œ userâ€** ì¼€ì´ìŠ¤ë¼ì„œ, Apple/Kakao ë¡œê·¸ì¸ê³¼ **ì„±ê²©ì´ ì™„ì „íˆ ë‹¤ë¥¸ ì‚¬ìš©ì ìœ í˜•**ì´ì•¼.

ì•„ë˜ì— **ì •ë¦¬ â†’ ì„¤ê³„ ì›ì¹™ â†’ í…Œì´ë¸” ì¬ì„¤ê³„ì•ˆ** ìˆœì„œë¡œ ê¹”ë”í•˜ê²Œ ì •ë¦¬í•´ì¤„ê²Œ.

---

## 1ï¸âƒ£ ìš”êµ¬ì‚¬í•­ ì¬ì •ë¦¬ (ì•„ì£¼ ì¤‘ìš”)

### ê²ŒìŠ¤íŠ¸(ANONYMOUS) ì‚¬ìš©ìì˜ íŠ¹ì§•

- âŒ íšŒì›ê°€ì… ì—†ìŒ
- âŒ ì†Œì…œ ë¡œê·¸ì¸ ì—†ìŒ
- â­• **ê¸°ê¸° ì •ë³´ ê¸°ë°˜ìœ¼ë¡œ user ìƒì„±**
- â­• ë°”ë¡œì ê¸ˆ / ì˜ˆì•½ì ê¸ˆ ì‚¬ìš© ê°€ëŠ¥
- â­• QR ìƒì„± â†’ ì„œë²„ ì €ì¥ í•„ìš”
- â­• ì ê¸ˆ ì˜¤ì‘ë™ ë°©ì§€ë¥¼ ìœ„í•´ **ê¸°ê¸°-ìœ ì € 1:1 ì¶”ì  í•„ìš”**
- â­• ì¶”í›„ ë¶€ëª¨/êµì‚¬ ê³„ì •ìœ¼ë¡œ **ì „í™˜ ê°€ëŠ¥ì„± ìˆìŒ**

ğŸ‘‰ ì¦‰, **ë¹„íšŒì›ì´ ì•„ë‹ˆë¼ â€œë¬´ì¸ì¦ ì‚¬ìš©ìâ€**ì— ê°€ê¹Œì›€

---

## 2ï¸âƒ£ í•µì‹¬ ì„¤ê³„ ì›ì¹™ (ì´ê±° ì•ˆ ì§€í‚¤ë©´ ë‚˜ì¤‘ì— ê¼¬ì„)

### ğŸ”‘ Principle 1

> **ëª¨ë“  ì ê¸ˆ/QR/ì •ì±…ì€ user_id ê¸°ì¤€ìœ¼ë¡œë§Œ ë™ì‘**

- ê¸°ê¸° UUIDë§Œ ë¯¿ìœ¼ë©´ ì•ˆ ë¨ (ìœ„ë³€ì¡°, ì¬ì„¤ì¹˜ ì´ìŠˆ)
- ì„œë²„ì—ì„œëŠ” ë°˜ë“œì‹œ user rowê°€ ìˆì–´ì•¼ í•¨

---

### ğŸ”‘ Principle 2

> **ANONYMOUSëŠ” auth_providerì˜ í•œ ì¢…ë¥˜ê°€ ì•„ë‹ˆë¼ â€œê³„ì • ìƒíƒœâ€**

â†’ í•˜ì§€ë§Œ êµ¬í˜„ í¸ì˜ìƒ `auth_provider = ANONYMOUS` ìœ ì§€ OK  
(ë‹¨, **ê¶Œí•œ/ê¸°ëŠ¥ ì œí•œ ëª…í™•íˆ**)

---

### ğŸ”‘ Principle 3

> **ANONYMOUS â†’ AUTH ì‚¬ìš©ìë¡œ â€œìŠ¹ê²©(upgrade)â€ ê°€ëŠ¥í•´ì•¼ í•¨**

- ê²ŒìŠ¤íŠ¸ â†’ ë¶€ëª¨ ë¡œê·¸ì¸
- ê¸°ì¡´ ì ê¸ˆ ì´ë ¥, QR, ë””ë°”ì´ìŠ¤ ìœ ì§€

---

## 3ï¸âƒ£ auth_provider_enum ìµœì¢… ì •ë¦¬ (ìˆ˜ì •ì•ˆ)

### âœ… ANONYMOUS ìœ ì§€ (í•„ìˆ˜)

```sql
DROP TYPE IF EXISTS auth_provider_enum CASCADE;

CREATE TYPE auth_provider_enum AS ENUM (
  'ANONYMOUS',  -- ê²ŒìŠ¤íŠ¸ (ê¸°ê¸° ê¸°ë°˜)
  'APPLE',
  'KAKAO',
  'EMAIL'
);
```

---

## 4ï¸âƒ£ users í…Œì´ë¸” ì¬ì„¤ê³„ (ê²ŒìŠ¤íŠ¸ ê³ ë ¤ ë²„ì „)

```sql
DROP TABLE IF EXISTS users CASCADE;

CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  -- ì¸ì¦ ìœ í˜•
  auth_provider auth_provider_enum NOT NULL,

  -- ì†Œì…œ ë¡œê·¸ì¸ ì‹ë³„ì
  apple_sub VARCHAR(255),
  kakao_user_id VARCHAR(50),

  -- ì—°ë½ì²˜ (ANONYMOUSì—ì„œëŠ” NULL í—ˆìš©)
  phone_number VARCHAR(20),
  email VARCHAR(255),

  display_name VARCHAR(50),

  status user_status_enum DEFAULT 'ACTIVE',

  -- ê²ŒìŠ¤íŠ¸ í”Œë˜ê·¸ (ì¿¼ë¦¬ ê°€ë…ì„±ìš©)
  is_guest BOOLEAN GENERATED ALWAYS AS (
    auth_provider = 'ANONYMOUS'
  ) STORED,

  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now(),

  -- ğŸ” ë¬´ê²°ì„± ì œì•½
  CONSTRAINT chk_social_identity
    CHECK (
      auth_provider = 'ANONYMOUS'
      OR apple_sub IS NOT NULL
      OR kakao_user_id IS NOT NULL
      OR email IS NOT NULL
    )
);
```





### ğŸ“Œ í¬ì¸íŠ¸

- ANONYMOUSëŠ” **phone/email ëª¨ë‘ NULL ê°€ëŠ¥**
- is_guestëŠ” ì»¬ëŸ¼ìœ¼ë¡œ ë“¤ê³  ìˆìœ¼ë©´ UX/ì •ì±… ë¶„ê¸° í¸í•¨
- Apple/KakaoëŠ” identifier í•„ìˆ˜

---

## 5ï¸âƒ£ devices í…Œì´ë¸”ì€ ì§€ê¸ˆ ì„¤ê³„ ê·¸ëŒ€ë¡œ OK (ì¤‘ìš”)

ğŸ‘‰ **â€œê²ŒìŠ¤íŠ¸ = 1 user : N devicesâ€** êµ¬ì¡°ê°€ ê°€ì¥ ì•ˆì „

```text
users (ANONYMOUS)
   â†“
devices (device_uuid, platform, permissionsâ€¦)
```

- ê¸°ê¸° ì¬ì„¤ì¹˜ â†’ ë™ì¼ device_uuidë©´ ì¬ì—°ê²°
- device êµì²´ â†’ ìƒˆ device row

---

## 6ï¸âƒ£ QR / ì ê¸ˆ ì„œë¹„ìŠ¤ì—ì„œì˜ ì²˜ë¦¬ ê¸°ì¤€

### QR ìƒì„± ì‹œ

```text
QR.owner_user_id = users.id (ANONYMOUS ê°€ëŠ¥)
QR.target_device_id = devices.id
QR.type = IMMEDIATE_LOCK | SCHEDULE_LOCK
```

### ì ê¸ˆ ì‹¤í–‰ ì‹œ

- âŒ device_uuid ì§ì ‘ ì‚¬ìš©
- â­• **user_id â†’ device ê²€ì¦ â†’ ì‹¤í–‰**

---

## 7ï¸âƒ£ ANONYMOUS â†’ ë¶€ëª¨/êµì‚¬ ê³„ì • ì „í™˜(Upgrade) í”Œë¡œìš°

### UX

```
[ê²ŒìŠ¤íŠ¸ë¡œ ì´ìš© ì¤‘]
   â†“
[ë¶€ëª¨ë¡œ ë¡œê·¸ì¸]
   â†“
"ê¸°ì¡´ ì ê¸ˆ ê¸°ë¡ì„ ìœ ì§€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?"
```

### ì„œë²„ ì²˜ë¦¬

```sql
UPDATE users
SET
  auth_provider = 'KAKAO',
  kakao_user_id = 'xxx',
  phone_number = '010...',
  updated_at = now()
WHERE id = :anonymous_user_id;
```

- user_id ìœ ì§€
- devices, locks, QR ì „ë¶€ ìœ ì§€ë¨ âœ…

---

## 8ï¸âƒ£ role êµ¬ì¡°ì™€ì˜ ê´€ê³„

- ANONYMOUSëŠ” **ê¸°ë³¸ role ì—†ìŒ**
- ëª…ì‹œì ìœ¼ë¡œ ê¶Œí•œ ë¶€ì—¬ í•„ìš”

```text
ANONYMOUS
 â†’ ì ê¸ˆ/QR ì‚¬ìš© ê°€ëŠ¥
 â†’ ê¸°ê´€/ë¶€ëª¨/êµì‚¬ ê¸°ëŠ¥ âŒ
```

ë¡œê·¸ì¸ í›„:

```sql
INSERT INTO user_roles (user_id, role)
VALUES (:user_id, 'PARENT');
```

---

## 9ï¸âƒ£ Apple / Kakao ì‹¬ì‚¬ ê´€ì ì—ì„œë„ ì•ˆì „í•œê°€?

âœ… â€œê²ŒìŠ¤íŠ¸ ì´ìš© ê°€ëŠ¥â€ ëª…í™•  
âœ… ë¡œê·¸ì¸ ê°•ì œ ì•„ë‹˜  
âœ… ë¶€ëª¨/êµì‚¬ ê¸°ëŠ¥ì€ ë¡œê·¸ì¸ í•„ìš”  
âœ… Apple ë¡œê·¸ì¸ ëŒ€ì²´ ìˆ˜ë‹¨ ì¡´ì¬

ğŸ‘‰ **ì‹¬ì‚¬ ë¦¬ìŠ¤í¬ ì—†ìŒ**

---

## 10ï¸âƒ£ ìµœì¢… ê²°ë¡  ìš”ì•½

- âœ… **ANONYMOUS ìœ ì§€í•´ì•¼ í•¨**
- âœ… ê¸°ê¸° ê¸°ë°˜ ì„œë¹„ìŠ¤ + ì„œë²„ user ê´€ë¦¬ êµ¬ì¡° ì í•©
- âœ… users í…Œì´ë¸”ì— í†µí•© ê´€ë¦¬ê°€ ìµœì„ 
- âœ… ì¶”í›„ ê³„ì • ìŠ¹ê²© ê°€ëŠ¥ êµ¬ì¡°ë¡œ ì„¤ê³„ ì™„ë£Œ
    

---


# âœ… Preset ì •ì±… ìµœì¢… ì„¤ê³„ (260210)

## 0ï¸âƒ£ ì„¤ê³„ ìš”ì•½ (í•µì‹¬ë§Œ)

|êµ¬ë¶„|ë‚´ìš©|
|---|---|
|Preset ëª©ì |ì ê¸ˆ / ì¶œì„ / ì ê¸ˆ+ì¶œì„|
|QR ì‚¬ìš©|ì¶œì„ ì „ìš© QR ê°€ëŠ¥|
|Scope|SYSTEM / ORG / USER|
|ì ê¸ˆ ì •ì±…|ATTENDANCE_ONLY ì—ì„œëŠ” **ì™„ì „ ë¹„í™œì„±**|
|í†µê³„|preset_usage ë¡œ ì¶”ì |

---

# 1ï¸âƒ£ ENUM ì •ì˜ (ë¨¼ì € ì‹¤í–‰)

```sql
-- Preset ì†Œìœ  ë²”ìœ„
CREATE TYPE preset_scope_enum AS ENUM (
  'SYSTEM',  -- ë½ëª¨ë¨¼íŠ¸ ì œê³µ
  'ORG',     -- ê¸°ê´€ ê³µìš©
  'USER'     -- ë¶€ëª¨/êµì‚¬ ê°œì¸
);

-- Preset ëª©ì  (í•µì‹¬)
CREATE TYPE preset_purpose_enum AS ENUM (
  'LOCK_ONLY',
  'ATTENDANCE_ONLY',
  'LOCK_AND_ATTENDANCE'
);

-- ì ê¸ˆ íƒ€ì…
CREATE TYPE lock_type_enum AS ENUM (
  'FULL',      -- ì „ì²´ ì ê¸ˆ
  'APP_ONLY'   -- ì•± ì ê¸ˆ
);

-- Preset ì ìš© ëŒ€ìƒ
CREATE TYPE preset_target_enum AS ENUM (
  'STUDENT',
  'DEVICE',
  'CLASS'
);
```

---

# 2ï¸âƒ£ preset_policies í…Œì´ë¸” (í•µì‹¬ í…Œì´ë¸”)

```sql
CREATE TABLE preset_policies (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  -- SYSTEM / ORG / USER
  scope preset_scope_enum NOT NULL,

  -- SYSTEM = NULL
  -- ORG    = organization_id
  -- USER   = user_id
  owner_id UUID NULL,

  name VARCHAR(100) NOT NULL,
  description TEXT,

  -- ğŸ”‘ Preset ëª©ì  (ì ê¸ˆ / ì¶œì„ / ë‘˜ë‹¤)
  purpose preset_purpose_enum NOT NULL DEFAULT 'LOCK_AND_ATTENDANCE',

  -- ğŸ” ì ê¸ˆ ê´€ë ¨ (ATTENDANCE_ONLY ì—ì„œëŠ” NULL)
  lock_type lock_type_enum,
  allowed_categories JSONB,
  blocked_categories JSONB,
  allowed_apps JSONB,
  default_duration_minutes INT,

  is_active BOOLEAN DEFAULT TRUE,

  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now(),

  -- ğŸ”’ ì¶œì„ ì „ìš© preset ë¬´ê²°ì„± ë³´ì¥
  CONSTRAINT chk_attendance_only_preset
    CHECK (
      purpose <> 'ATTENDANCE_ONLY'
      OR (
        lock_type IS NULL
        AND allowed_categories IS NULL
        AND blocked_categories IS NULL
        AND allowed_apps IS NULL
        AND default_duration_minutes IS NULL
      )
    )
);
```

---

## ğŸ“Œ ì¸ë±ìŠ¤ (ì‹¤ìš´ì˜ í•„ìˆ˜)

```sql
-- scope + owner ê¸°ì¤€ ì¡°íšŒ (ê¸°ê´€/ìœ ì € preset ëª©ë¡)
CREATE INDEX idx_preset_policies_scope_owner
  ON preset_policies(scope, owner_id);

-- í™œì„± preset ë¹ ë¥¸ ì¡°íšŒ
CREATE INDEX idx_preset_policies_active
  ON preset_policies(is_active);

-- purpose í•„í„° (ì¶œì„ ì „ìš© / ì ê¸ˆ ì „ìš©)
CREATE INDEX idx_preset_policies_purpose
  ON preset_policies(purpose);
```

---

# 3ï¸âƒ£ preset_usage í…Œì´ë¸” (ì‚¬ìš© ì¶”ì  & í†µê³„)

```sql
CREATE TABLE preset_usage (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  preset_id UUID NOT NULL
    REFERENCES preset_policies(id)
    ON DELETE CASCADE,

  used_by UUID NOT NULL
    REFERENCES users(id),

  target_type preset_target_enum NOT NULL,
  target_id UUID NOT NULL,

  purpose preset_purpose_enum NOT NULL,

  -- ì ê¸ˆ presetì¼ ê²½ìš°ë§Œ ì—°ê²°
  applied_policy_id UUID
    REFERENCES lock_policies(id),

  applied_at TIMESTAMPTZ DEFAULT now()
);
```

### ì¸ë±ìŠ¤

```sql
CREATE INDEX idx_preset_usage_preset
  ON preset_usage(preset_id);

CREATE INDEX idx_preset_usage_used_by
  ON preset_usage(used_by);

CREATE INDEX idx_preset_usage_target
  ON preset_usage(target_type, target_id);

CREATE INDEX idx_preset_usage_applied_at
  ON preset_usage(applied_at);
```

---

# 4ï¸âƒ£ lock_policies í…Œì´ë¸” (Preset ì—°ê³„ ì „ì œ)

> ì•„ì§ ìƒì„± ì „ì´ë¼ë©´ **ì²˜ìŒë¶€í„° ì•„ë˜ êµ¬ì¡°ë¡œ ê°€ëŠ” ê±¸ ì¶”ì²œ**

```sql
CREATE TABLE lock_policies (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  preset_id UUID
    REFERENCES preset_policies(id),

  purpose preset_purpose_enum NOT NULL DEFAULT 'LOCK_ONLY',

  lock_type lock_type_enum NOT NULL,
  allowed_categories JSONB,
  blocked_categories JSONB,
  allowed_apps JSONB,

  duration_minutes INT NOT NULL,

  is_customized BOOLEAN DEFAULT FALSE,

  created_by UUID REFERENCES users(id),
  created_at TIMESTAMPTZ DEFAULT now()
);
```

---

# 5ï¸âƒ£ QR ìƒì„± ì‹œ ë™ì‘ ë§¤í•‘ (ì„œë²„ ë¡œì§ ê¸°ì¤€)

|preset.purpose|lock_policies ìƒì„±|ì¶œì„ ê¸°ë¡|
|---|---|---|
|ATTENDANCE_ONLY|âŒ|âœ…|
|LOCK_ONLY|âœ…|âŒ|
|LOCK_AND_ATTENDANCE|âœ…|âœ…|



ì¢‹ì€ íƒ€ì´ë°ì´ì•¼. ì§€ê¸ˆ ì‹œë‚˜ë¦¬ì˜¤ê°€ **QR = ì •ì±… ì‹¤í–‰ íŠ¸ë¦¬ê±°(ì¶œì„/ì ê¸ˆ/í˜¼í•©)** ë¡œ ëª…í™•í•´ì¡Œê¸° ë•Œë¬¸ì—  
ê¸°ì¡´ `qr_codes`, `qr_device_usage` ëŠ” **êµ¬ì¡°ì ìœ¼ë¡œ ê°ˆì•„ì—ëŠ” ê²Œ ë§ìŒ** ğŸ‘  
ìš”ì²­ëŒ€ë¡œ **DROP â†’ ì‹ ê·œ ìƒì„±**, enum / index ê¹Œì§€ í¬í•¨í•´ì„œ ì •ë¦¬í•´ì¤„ê²Œ.

ì•„ë˜ëŠ” **PostgreSQL ê¸°ì¤€ ìµœì¢…ì•ˆ(v2)** ì´ì•¼.

---

## 0ï¸âƒ£ ì „ì œ: ì‹ ê·œ Enum ì •ì˜

### QR íƒ€ì… / ëª©ì  / ìŠ¤ì¼€ì¤„ / ëŒ€ìƒ

```sql
-- QR ê³ ì •/ë™ì 
CREATE TYPE qr_type_enum AS ENUM (
  'STATIC',     -- ê³ ì •í˜• (ë¶€ëª¨/ì¼ë°˜/ê¸°ê´€ ì¶œì„íŒ)
  'DYNAMIC'     -- 1íšŒì„±/ì„¸ì…˜ìš©
);

-- QR ëª©ì  (Preset purposeì™€ 1:1)
CREATE TYPE qr_purpose_enum AS ENUM (
  'ATTENDANCE_ONLY',
  'LOCK_ONLY',
  'LOCK_AND_ATTENDANCE'
);

-- QR ìŠ¤ì¼€ì¤„ ë°©ì‹
CREATE TYPE qr_schedule_mode_enum AS ENUM (
  'IMMEDIATE',
  'RESERVED'
);

-- QR ì ìš© ëŒ€ìƒ
CREATE TYPE qr_target_type_enum AS ENUM (
  'CLASS',
  'STUDENT',
  'DEVICE',
  'HOME'
);

-- QR ìƒíƒœ
CREATE TYPE qr_status_enum AS ENUM (
  'ACTIVE',
  'EXPIRED',
  'REVOKED'
);
```

---

## 1ï¸âƒ£ ê¸°ì¡´ í…Œì´ë¸” DROP

```sql
DROP TABLE IF EXISTS qr_device_usage CASCADE;
DROP TABLE IF EXISTS qr_codes CASCADE;
```

---

## 2ï¸âƒ£ qr_codes (QR ë©”íƒ€ + ì •ì±… ì¤‘ì‹¬)

> âœ… QR = â€œë¬´ì—‡ì„ ì‹¤í–‰í• ì§€ ì •ì˜í•˜ëŠ” ì—”í‹°í‹°â€

```sql
CREATE TABLE qr_codes (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  -- QR ê¸°ë³¸ ì„±ê²©
  qr_type qr_type_enum NOT NULL,
  purpose qr_purpose_enum NOT NULL,

  -- Preset / Policy ì—°ê³„
  preset_id UUID NULL REFERENCES preset_policies(id),
  lock_policy_id UUID NULL REFERENCES lock_policies(id),

  -- ëŒ€ìƒ ì •ë³´
  target_type qr_target_type_enum NOT NULL,
  target_id UUID NOT NULL,

  -- ìŠ¤ì¼€ì¤„
  schedule_mode qr_schedule_mode_enum NOT NULL DEFAULT 'IMMEDIATE',
  valid_from TIMESTAMPTZ NULL,
  valid_to TIMESTAMPTZ NULL,

  -- ì‚¬ìš© ì œì–´
  one_time BOOLEAN DEFAULT FALSE,
  max_scan_count INT NULL, -- NULL = ë¬´ì œí•œ

  -- ìƒíƒœ
  status qr_status_enum DEFAULT 'ACTIVE',

  -- ìƒì„±ì
  created_by UUID NOT NULL REFERENCES users(id),
  created_at TIMESTAMPTZ DEFAULT now(),

  -- ë¬´ê²°ì„± ì²´í¬
  CONSTRAINT chk_qr_valid_time
    CHECK (
      valid_from IS NULL
      OR valid_to IS NULL
      OR valid_from < valid_to
    )
);
```

### ğŸ“Œ í•µì‹¬ í¬ì¸íŠ¸

- **ì¶œì„-only QRë„ preset_idë§Œ ìˆìœ¼ë©´ ë™ì‘**
- ì ê¸ˆ ì—†ëŠ” QR â†’ `lock_policy_id IS NULL`
- ì˜ˆì•½ QR â†’ `valid_from / valid_to` ì‚¬ìš©

---

## 3ï¸âƒ£ qr_device_usage (ì‹¤ì œ ìŠ¤ìº” & ì‹¤í–‰ ë¡œê·¸)

> âœ… â€œëˆ„ê°€, ì–´ë–¤ ê¸°ê¸°ë¡œ, ë¬´ì—‡ì´ ì‹¤í–‰ëëŠ”ì§€â€

```sql
CREATE TABLE qr_device_usage (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  qr_id UUID NOT NULL REFERENCES qr_codes(id) ON DELETE CASCADE,

  -- ìŠ¤ìº” ì£¼ì²´
  user_id UUID NOT NULL REFERENCES users(id),
  device_id UUID NOT NULL REFERENCES devices(id),

  -- ì‹¤í–‰ ê²°ê³¼
  attendance_recorded BOOLEAN DEFAULT FALSE,
  lock_applied BOOLEAN DEFAULT FALSE,

  -- ì‹¤íŒ¨/ì˜ˆì™¸ ì¶”ì 
  failure_reason TEXT NULL,

  scanned_at TIMESTAMPTZ DEFAULT now(),

  -- 1íšŒì„± QR ë³´í˜¸
  CONSTRAINT uq_qr_device_once
    UNIQUE (qr_id, device_id)
);
```

---

## 4ï¸âƒ£ ì¸ë±ìŠ¤ ì„¤ê³„ (ì¤‘ìš”)

### qr_codes

```sql
CREATE INDEX idx_qr_codes_status
  ON qr_codes(status);

CREATE INDEX idx_qr_codes_target
  ON qr_codes(target_type, target_id);

CREATE INDEX idx_qr_codes_valid_time
  ON qr_codes(valid_from, valid_to);

CREATE INDEX idx_qr_codes_created_by
  ON qr_codes(created_by);
```

---

### qr_device_usage

```sql
CREATE INDEX idx_qr_usage_qr
  ON qr_device_usage(qr_id);

CREATE INDEX idx_qr_usage_user
  ON qr_device_usage(user_id);

CREATE INDEX idx_qr_usage_device
  ON qr_device_usage(device_id);

CREATE INDEX idx_qr_usage_scanned_at
  ON qr_device_usage(scanned_at);
```

---

## 5ï¸âƒ£ ë³€ê²½ëœ ì‹œë‚˜ë¦¬ì˜¤ì™€ì˜ ë§¤í•‘ ì •ë¦¬

|ì‹œë‚˜ë¦¬ì˜¤|qr_codes ì„¤ì •|
|---|---|
|ì¶œì„ ì „ìš© QR|purpose=ATTENDANCE_ONLY, lock_policy_id=NULL|
|ì ê¸ˆ ì „ìš© QR|purpose=LOCK_ONLY|
|ìˆ˜ì—… QR|target_type=CLASS|
|ë¶€ëª¨ ê³ ì • QR|qr_type=STATIC, one_time=false|
|1íšŒì„± ìˆ˜ì—… QR|qr_type=DYNAMIC, one_time=true|
|ì˜ˆì•½ ì ê¸ˆ|schedule_mode=RESERVED + valid_from|

---

# 1ï¸âƒ£ ì„¤ê³„ ì›ì¹™ (í•µì‹¬ ìš”ì•½)

### ê´€ê³„ ì •ë¦¬ ê²°ë¡ 

- **qr_device_usage = â€œí–‰ìœ„ ë¡œê·¸ (scan & ì‹¤í–‰ ê²°ê³¼)â€**
- **attendance = â€œê³µì‹ ì¶œì„ ê¸°ë¡ (ë¹„ì¦ˆë‹ˆìŠ¤ ê¸°ì¤€ ë°ì´í„°)â€**
- ê´€ê³„ëŠ” **1 : 0..1**
    - ëª¨ë“  QR ìŠ¤ìº”ì´ ì¶œì„ì€ ì•„ë‹˜
    - ì¶œì„ì´ ë°œìƒí•œ ê²½ìš°ë§Œ attendance row ìƒì„±
- **attendanceëŠ” ë°˜ë“œì‹œ qr_device_usageë¥¼ ì°¸ì¡°** (ì¶œì²˜ ëª…í™•í™”)

---
# 2ï¸âƒ£ ì‹ ê·œ Enum ì •ì˜ (ì¶œì„ ìƒíƒœ í™•ì¥ ëŒ€ë¹„)

```sql
CREATE TYPE attendance_status_enum AS ENUM (
  'PRESENT',     -- ì •ìƒ ì¶œì„
  'LATE',        -- ì§€ê°
  'ABSENT',      -- ê²°ì„ (ì˜ˆì•½/ê´€ë¦¬ì ì²˜ë¦¬)
  'EXCUSED'      -- ì‚¬ìœ  ì¸ì •
);
```

> ğŸ’¡ ì§€ê¸ˆì€ PRESENT ìœ„ì£¼ë¡œ ì“°ê³   
> ì´í›„ ì˜ˆì•½ QR, ìˆ˜ë™ ì²˜ë¦¬ ì‹œ í™•ì¥ ê°€ëŠ¥

# 3ï¸âƒ£ ê¸°ì¡´ attendance í…Œì´ë¸” DROP


```sql
DROP TABLE IF EXISTS attendance CASCADE;
```

---

# 4ï¸âƒ£ attendance í…Œì´ë¸” ì‹ ê·œ ìƒì„± (ì •ê·œí™” ë²„ì „)

```sql
CREATE TABLE attendance (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  -- ì¶œì„ ì¶œì²˜ (í•µì‹¬)
  qr_usage_id UUID NOT NULL
    REFERENCES qr_device_usage(id) ON DELETE CASCADE,

  -- ì†Œì† ì •ë³´
  organization_id UUID NOT NULL
    REFERENCES organizations(id),

  class_id UUID NULL
    REFERENCES classes(id),

  -- ì¶œì„ ëŒ€ìƒ
  student_id UUID NOT NULL
    REFERENCES users(id),

  device_id UUID NOT NULL
    REFERENCES devices(id),

  -- ì¶œì„ ìƒíƒœ
  status attendance_status_enum NOT NULL DEFAULT 'PRESENT',

  -- ì¶œì„ ì‹œê° (QR scan ì‹œê°ê³¼ ë¶„ë¦¬ ê°€ëŠ¥)
  attended_at TIMESTAMPTZ NOT NULL DEFAULT now(),

  -- ê´€ë¦¬ì ë³´ì •
  marked_by UUID NULL REFERENCES users(id),
  memo TEXT NULL,

  created_at TIMESTAMPTZ DEFAULT now(),

  -- ë™ì¼ QR ì‚¬ìš©ìœ¼ë¡œ ì¤‘ë³µ ì¶œì„ ë°©ì§€
  CONSTRAINT uq_attendance_qr_usage UNIQUE (qr_usage_id)
);
```

---

# 5ï¸âƒ£ í•µì‹¬ ì¸ë±ìŠ¤ ì„¤ê³„ (í†µê³„ & ì¡°íšŒ ìµœì í™”)

```sql
-- í•™ìƒë³„ ì¶œì„ ì´ë ¥
CREATE INDEX idx_attendance_student
  ON attendance(student_id);

-- ìˆ˜ì—…ë³„ ì¶œì„ í†µê³„
CREATE INDEX idx_attendance_class
  ON attendance(class_id);

-- ê¸°ê´€ë³„ ì¶œì„ ì¡°íšŒ
CREATE INDEX idx_attendance_org
  ON attendance(organization_id);

-- ë‚ ì§œ ê¸°ì¤€ ì¡°íšŒ (ì¼/ì›” í†µê³„)
CREATE INDEX idx_attendance_attended_at
  ON attendance(attended_at);

-- QR ê¸°ë°˜ ì—­ì¶”ì 
CREATE INDEX idx_attendance_qr_usage
  ON attendance(qr_usage_id);
```


