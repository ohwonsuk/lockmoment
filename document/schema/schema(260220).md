-- LockMoment Schema Upgrade (260220)
-- Îã§Ï§ë Î≥¥Ìò∏Ïûê(Many-to-Many) Î∞è Îã§Ï§ë Í∏∞Í¥Ä ÏÜåÏÜç ÏßÄÏõê ÌÜµÌï© Ïä§ÌÇ§Îßà

-- 1. Í∏∞Ï¥à Î∂ÑÎ•ò Î∞è Enum (Í∏∞Ï°¥ ÌÜµÌï©)
CREATE TYPE device_platform_enum AS ENUM ('IOS', 'ANDROID');
CREATE TYPE device_status_enum AS ENUM ('ACTIVE', 'INACTIVE', 'REVOKED');
CREATE TYPE permission_state_enum AS ENUM ('GRANTED', 'DENIED', 'NOT_DETERMINED');
CREATE TYPE day_of_week_enum AS ENUM ('MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT', 'SUN');
CREATE TYPE schedule_status_enum AS ENUM ('ACTIVE', 'PAUSED', 'DELETED');
CREATE TYPE auth_provider_enum AS ENUM ('ANONYMOUS', 'APPLE', 'KAKAO', 'EMAIL');
CREATE TYPE role_type_enum AS ENUM ('PARENT', 'CHILD', 'TEACHER', 'ORG_ADMIN', 'ORG_STAFF', 'SERVICE_ADMIN', 'TESTER');
CREATE TYPE preset_scope_enum AS ENUM ('SYSTEM', 'ORG', 'USER');
CREATE TYPE preset_purpose_enum AS ENUM ('LOCK_ONLY', 'ATTENDANCE_ONLY', 'LOCK_AND_ATTENDANCE');
CREATE TYPE lock_type_enum AS ENUM ('FULL', 'APP_ONLY');
CREATE TYPE preset_category_enum AS ENUM ('HOME', 'SCHOOL', 'COMMON');

-- 2. ÌïµÏã¨ Ï†ïÎ≥¥ ÌÖåÏù¥Î∏î

-- [ÏÇ¨Ïö©Ïûê]
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  -- Ïù∏Ï¶ù Ïú†Ìòï
  auth_provider auth_provider_enum NOT NULL,

  -- ÏÜåÏÖú Î°úÍ∑∏Ïù∏ ÏãùÎ≥ÑÏûê
  apple_sub VARCHAR(255),
  kakao_user_id VARCHAR(50),

  -- Ïó∞ÎùΩÏ≤ò (ANONYMOUSÏóêÏÑúÎäî NULL ÌóàÏö©)
  phone_number VARCHAR(20),
  email VARCHAR(255),

  display_name VARCHAR(50),
  birth_year INTEGER, -- Ï∂úÏÉùÏó∞ÎèÑ (260220 Ï∂îÍ∞Ä)

  status user_status_enum DEFAULT 'ACTIVE',

  -- Í≤åÏä§Ìä∏ ÌîåÎûòÍ∑∏ (ÏøºÎ¶¨ Í∞ÄÎèÖÏÑ±Ïö©)
  is_guest BOOLEAN GENERATED ALWAYS AS (
    auth_provider = 'ANONYMOUS'
  ) STORED,

  -- üîê Î≥¥Ïïà Î∞è Ï†úÏñ¥ (260219 Ï∂îÍ∞Ä)
  pin_code VARCHAR(6),                -- ÎÇ¥ Ï†ïÎ≥¥ Ï†ëÍ∑ºÏö© 6ÏûêÎ¶¨ PIN
  restrict_my_info BOOLEAN DEFAULT FALSE, -- Î∂ÄÎ™®Ïùò ÏûêÎÖÄ ÌôîÎ©¥ Ï†ëÍ∑º Ï†úÌïú ÌîåÎûòÍ∑∏

  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now(),

  -- üîê Î¨¥Í≤∞ÏÑ± Ï†úÏïΩ
  CONSTRAINT chk_social_identity
    CHECK (
      auth_provider = 'ANONYMOUS'
      OR apple_sub IS NOT NULL
      OR kakao_user_id IS NOT NULL
      OR email IS NOT NULL
    )
);

-- [Í∏∞Í¥Ä]
CREATE TABLE organizations (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(255) NOT NULL,
    address VARCHAR(255),
    org_type org_type_enum NOT NULL,
    business_number VARCHAR(50),
    status org_status_enum DEFAULT 'PENDING',
    created_at TIMESTAMPTZ DEFAULT now()
);

-- [Í∏∞Í∏∞]
CREATE TABLE devices (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  platform device_platform_enum NOT NULL,
  device_uuid VARCHAR(255) NOT NULL UNIQUE,
  device_model VARCHAR(100),
  os_version VARCHAR(20),
  app_version VARCHAR(20),
  accessibility_permission permission_state_enum,
  screen_time_permission permission_state_enum,
  notification_permission permission_state_enum,
  last_permission_sync TIMESTAMPTZ,
  is_active BOOLEAN DEFAULT TRUE,
  last_seen_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);

-- 3. Í¥ÄÍ≥Ñ(Relation) ÌÖåÏù¥Î∏î Í≥†ÎèÑÌôî

-- [Î∂ÄÎ™®-ÏûêÎÖÄ] Îã§Ï§ë Î≥¥Ìò∏Ïûê ÏßÄÏõê (Many-to-Many)
CREATE TABLE parent_child_relations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  parent_user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  child_user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  nickname VARCHAR(50),               -- Î∂ÄÎ™®Í∞Ä ÏÑ§Ï†ïÌïú ÏûêÎÖÄÏùò Î≥ÑÎ™Ö
  is_primary BOOLEAN DEFAULT FALSE,   -- Ï£º Î≥¥Ìò∏Ïûê Ïó¨Î∂Ä (ÏµúÎåÄ 2Î™Ö Í∂åÏû•Ïù¥ÎÇò Íµ¨Ï°∞ÏÉÅ NÎ™Ö Í∞ÄÎä•)
  created_at TIMESTAMPTZ DEFAULT now(),
  CONSTRAINT uq_parent_child UNIQUE (parent_user_id, child_user_id)
);

-- [Í∏∞Í¥Ä Î©§Î≤ÑÏã≠/Ïó≠Ìï†] Îã§Ï§ë Í∏∞Í¥Ä ÏßÄÏõê
CREATE TABLE user_roles (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  role role_type_enum NOT NULL,
  scope_type TEXT CHECK (scope_type IN ('GLOBAL', 'ORG', 'CHILD', 'CLASS')) DEFAULT 'GLOBAL',
  scope_id UUID,                      -- organization_id ÎòêÎäî child_user_id Îì±
  assigned_at TIMESTAMPTZ DEFAULT now(),
  CONSTRAINT uq_user_role_scope UNIQUE NULLS NOT DISTINCT (user_id, role, scope_id)
);

-- 4. Ïû†Í∏à Î∞è Ï†ïÏ±Ö (v260214 Í∏∞Ï§Ä Î∞òÏòÅ)

CREATE TABLE preset_policies (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  scope preset_scope_enum NOT NULL,
  category preset_category_enum DEFAULT 'COMMON',
  owner_id UUID NULL,                 -- ORG id ÎòêÎäî USER id
  name VARCHAR(100) NOT NULL,
  description TEXT,
  purpose preset_purpose_enum NOT NULL DEFAULT 'LOCK_AND_ATTENDANCE',
  lock_type lock_type_enum,
  allowed_categories JSONB,
  blocked_categories JSONB,
  allowed_apps JSONB,
  default_duration_minutes INT,
  is_active BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);

CREATE TABLE lock_policies (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  preset_id UUID REFERENCES preset_policies(id),
  title VARCHAR(100),
  purpose preset_purpose_enum NOT NULL DEFAULT 'LOCK_ONLY',
  lock_type lock_type_enum NOT NULL,
  allowed_categories JSONB,
  blocked_categories JSONB,
  allowed_apps JSONB,
  duration_minutes INT NOT NULL,
  time_window VARCHAR(50),
  days JSONB,
  is_customized BOOLEAN DEFAULT FALSE,
  created_by UUID REFERENCES users(id),
  created_at TIMESTAMPTZ DEFAULT now()
);

-- [ÌôúÏÑ± Ïû†Í∏à Ïã§ÏãúÍ∞Ñ Ï∂îÏ†Å]
CREATE TABLE active_locks (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  device_id UUID REFERENCES devices(id) ON DELETE CASCADE,
  lock_name VARCHAR(100) NOT NULL,
  lock_type lock_type_enum NOT NULL,
  started_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  ends_at TIMESTAMPTZ NOT NULL,
  lock_policy_id UUID REFERENCES lock_policies(id),
  preset_id UUID REFERENCES preset_policies(id),
  allowed_apps JSONB,
  blocked_apps JSONB,
  prevent_app_removal BOOLEAN DEFAULT FALSE,
  source VARCHAR(50),                 -- 'MANUAL', 'SCHEDULED', 'QR', 'PRESET'
  initiated_by UUID REFERENCES users(id), -- Ïû†Í∏àÏùÑ ÏãúÏûëÌïú Ï£ºÏ≤¥
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  CONSTRAINT chk_active_locks_time CHECK (ends_at > started_at)
);

-- [Ïä§ÏºÄÏ§Ñ]
CREATE TABLE child_schedules (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  child_user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  name VARCHAR(100) NOT NULL,
  start_time TIME NOT NULL,
  end_time TIME NOT NULL,
  days JSONB NOT NULL,
  lock_type lock_type_enum NOT NULL DEFAULT 'FULL',
  allowed_apps JSONB,
  blocked_apps JSONB,
  allowed_categories JSONB,
  blocked_categories JSONB,
  is_active BOOLEAN DEFAULT TRUE,
  created_by UUID REFERENCES users(id),
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);

-- 5. Ïù∏Îç±Ïä§ (Ï°∞Ìöå ÏµúÏ†ÅÌôî)
CREATE INDEX idx_parent_child_parent ON parent_child_relations(parent_user_id);
CREATE INDEX idx_parent_child_child ON parent_child_relations(child_user_id);
CREATE INDEX idx_user_roles_user ON user_roles(user_id);
CREATE INDEX idx_user_roles_scope ON user_roles(scope_type, scope_id);
CREATE INDEX idx_active_locks_user_ends ON active_locks(user_id, ends_at);
CREATE INDEX idx_devices_user ON devices(user_id);

-- 6. Î©îÌÉÄÎç∞Ïù¥ÌÑ∞ (Ïï± Î∞è Ïπ¥ÌÖåÍ≥†Î¶¨)
CREATE TABLE app_categories (
  id VARCHAR(50) PRIMARY KEY,
  display_name VARCHAR(100) NOT NULL,
  ios_category VARCHAR(100),
  android_label VARCHAR(100),
  created_at TIMESTAMPTZ DEFAULT now()
);

CREATE TABLE app_category_map (
  id SERIAL PRIMARY KEY,
  app_name VARCHAR(255) NOT NULL,
  package_name VARCHAR(255) NOT NULL,
  category VARCHAR(50) REFERENCES app_categories(id),
  created_at TIMESTAMPTZ DEFAULT now()
);
