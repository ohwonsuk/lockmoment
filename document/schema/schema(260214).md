-- LockMoment Schema Upgrade (260214)
-- ì‚¬ì „ ë“±ë¡(Preset) ì¹´í…Œê³ ë¦¬í™” ë° ë¶€ëª¨/í™ˆ ì¼€ì–´ ë°ì´í„° ë°˜ì˜

-- 1. ì‹ ê·œ ì¹´í…Œê³ ë¦¬ Enum ì¶”ê°€ (ì—†ì„ ê²½ìš° ìƒì„±)
DO $$ BEGIN
    IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'preset_category_enum') THEN
        CREATE TYPE preset_category_enum AS ENUM ('HOME', 'SCHOOL', 'COMMON');
    END IF;
END $$;

-- 2. preset_policies í…Œì´ë¸” ì‹ ê·œ ì •ì˜ (ì¹´í…Œê³ ë¦¬ í•„ë“œ í¬í•¨)
DROP TABLE IF EXISTS preset_policies CASCADE;
CREATE TABLE preset_policies (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  -- SYSTEM / ORG / USER
  scope preset_scope_enum NOT NULL,
  
  -- 260214 ì¶”ê°€: HOME / SCHOOL / COMMON
  category preset_category_enum DEFAULT 'COMMON',

  -- SYSTEM = NULL
  -- ORG    = organization_id
  -- USER   = user_id
  owner_id UUID NULL,

  name VARCHAR(100) NOT NULL,
  description TEXT,

  -- ğŸ”‘ Preset ëª©ì  (ì ê¸ˆ / ì¶œì„ / ë‘˜ë‹¤)
  purpose preset_purpose_enum NOT NULL DEFAULT 'LOCK_AND_ATTENDANCE',

  -- ğŸ” ì ê¸ˆ ê´€ë ¨ (ATTENDANCE_ONLY ì—ì„œëŠ” NULL)
  lock_type lock_type_enum,
  allowed_categories JSONB,
  blocked_categories JSONB,
  allowed_apps JSONB,
  default_duration_minutes INT,

  is_active BOOLEAN DEFAULT TRUE,

  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now(),

  -- ğŸ”’ ì¶œì„ ì „ìš© preset ë¬´ê²°ì„± ë³´ì¥
  CONSTRAINT chk_attendance_only_preset
    CHECK (
      purpose <> 'ATTENDANCE_ONLY'
      OR (
        lock_type IS NULL
        AND allowed_categories IS NULL
        AND blocked_categories IS NULL
        AND allowed_apps IS NULL
        AND default_duration_minutes IS NULL
      )
    )
);

-- updated_at ìë™ ê°±ì‹  íŠ¸ë¦¬ê±° ì—°ë™
CREATE TRIGGER trg_preset_policies_updated_at
BEFORE UPDATE ON preset_policies
FOR EACH ROW
EXECUTE FUNCTION set_updated_at();

-- ì¸ë±ìŠ¤ ë³´ì™„
CREATE INDEX idx_preset_policies_scope_category ON preset_policies(scope, category);
CREATE INDEX idx_preset_policies_owner ON preset_policies(owner_id) WHERE owner_id IS NOT NULL;

-- 3. ê¸°ì¡´ í…Œì´ë¸” ì´ˆê¸°í™” ë° ì¬ìƒì„± (ì •í•©ì„± ë³´ì¥)
-- ê´€ê³„ ìˆœì„œì— ë”°ë¼ ì‚­ì œ (CASCADE ì§€ì›)
DROP TABLE IF EXISTS preset_usage CASCADE;
DROP TABLE IF EXISTS qr_device_usage CASCADE;
DROP TABLE IF EXISTS qr_codes CASCADE;
DROP TABLE IF EXISTS lock_policies CASCADE;

-- [A] lock_policies í…Œì´ë¸” (ì‹ ê·œ í•„ë“œ í¬í•¨ ì •ì‹ ìƒì„±)
CREATE TABLE lock_policies (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  preset_id UUID REFERENCES preset_policies(id),
  
  title VARCHAR(100), -- ì •ì±… ëª…ì¹­
  purpose preset_purpose_enum NOT NULL DEFAULT 'LOCK_ONLY',
  
  lock_type lock_type_enum NOT NULL,
  allowed_categories JSONB,
  blocked_categories JSONB,
  allowed_apps JSONB,
  
  duration_minutes INT NOT NULL,
  
  -- ì˜ˆì•½ ì •ë³´ í•„ë“œ (260215)
  time_window VARCHAR(50), -- ì˜ˆ: "09:00-10:00"
  days JSONB,              -- ì˜ˆ: ["ì›”", "í™”"]

  is_customized BOOLEAN DEFAULT FALSE,

  created_by UUID REFERENCES users(id),
  created_at TIMESTAMPTZ DEFAULT now()
);

-- [B] QR ì½”ë“œ í…Œì´ë¸”
CREATE TABLE qr_codes (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  qr_type qr_type_enum NOT NULL,
  purpose qr_purpose_enum NOT NULL,
  preset_id UUID NULL REFERENCES preset_policies(id),
  lock_policy_id UUID NULL REFERENCES lock_policies(id) ON DELETE CASCADE,
  target_type qr_target_type_enum NOT NULL,
  target_id UUID NOT NULL,
  schedule_mode qr_schedule_mode_enum NOT NULL DEFAULT 'IMMEDIATE',
  valid_from TIMESTAMPTZ NULL,
  valid_to TIMESTAMPTZ NULL,
  one_time BOOLEAN DEFAULT FALSE,
  max_scan_count INT NULL,
  status qr_status_enum DEFAULT 'ACTIVE',
  hmac_sig VARCHAR(255),
  created_by UUID NOT NULL REFERENCES users(id),
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);

-- QR ìŠ¤ìº” ì‚¬ìš© ê¸°ë¡ (ìŠ¤ìº” ì‹œ ë””ë°”ì´ìŠ¤ ì²´í¬ ê°•í™”)
CREATE TABLE qr_device_usage (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  qr_id UUID NOT NULL REFERENCES qr_codes(id) ON DELETE CASCADE,
  user_id UUID NULL REFERENCES users(id), -- ë¹„ë¡œê·¸ì¸ ìŠ¤ìº” ê°€ëŠ¥ì„± ëŒ€ë¹„ NULL í—ˆìš©
  device_id UUID NULL REFERENCES devices(id), -- ì—°ë™ ì „ ê¸°ê¸° ìŠ¤ìº” ê°€ëŠ¥ì„± ëŒ€ë¹„ NULL í—ˆìš©
  raw_device_uuid TEXT NULL, -- ì¡°íšŒë˜ì§€ ì•Šì€ ê¸°ê¸°ì˜ ì‹ë³„ê°’ ê¸°ë¡ìš©
  scanned_at TIMESTAMPTZ DEFAULT now(),
  lock_applied BOOLEAN DEFAULT FALSE,
  failure_reason TEXT NULL
);

-- [D] preset_usage í…Œì´ë¸” (ê´€ê³„ ë³µì›)
CREATE TABLE preset_usage (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  preset_id UUID NOT NULL REFERENCES preset_policies(id) ON DELETE CASCADE,
  used_by UUID NOT NULL REFERENCES users(id),
  target_type preset_target_enum NOT NULL DEFAULT 'STUDENT', 
  target_id UUID NOT NULL,
  purpose preset_purpose_enum NOT NULL,
  applied_policy_id UUID REFERENCES lock_policies(id) ON DELETE SET NULL,
  applied_at TIMESTAMPTZ DEFAULT now()
);

-- [E] active_locks í…Œì´ë¸” (ì‹¤ì‹œê°„ ì ê¸ˆ ìƒíƒœ ì¶”ì )
-- ë¶€ëª¨ê°€ ìë…€ì˜ í˜„ì¬ ì ê¸ˆ ìƒíƒœë¥¼ í™•ì¸í•  ìˆ˜ ìˆë„ë¡ ì§€ì›
CREATE TABLE active_locks (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  
  -- ì ê¸ˆ ëŒ€ìƒ
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  device_id UUID REFERENCES devices(id) ON DELETE CASCADE,
  
  -- ì ê¸ˆ ì •ë³´
  lock_name VARCHAR(100) NOT NULL,
  lock_type lock_type_enum NOT NULL,
  
  -- ì‹œê°„ ì •ë³´
  started_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  ends_at TIMESTAMPTZ NOT NULL,
  
  -- ì ê¸ˆ ì •ì±… (ì„ íƒì‚¬í•­)
  lock_policy_id UUID REFERENCES lock_policies(id) ON DELETE SET NULL,
  preset_id UUID REFERENCES preset_policies(id) ON DELETE SET NULL,
  
  -- ì ê¸ˆ ì„¤ì •
  allowed_apps JSONB,
  blocked_apps JSONB,
  prevent_app_removal BOOLEAN DEFAULT FALSE,
  
  -- ë©”íƒ€ë°ì´í„°
  source VARCHAR(50), -- 'MANUAL', 'SCHEDULED', 'QR', 'PRESET'
  initiated_by UUID REFERENCES users(id), -- ì ê¸ˆì„ ì‹œì‘í•œ ì‚¬ìš©ì (ë¶€ëª¨/êµì‚¬)
  
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- ì¸ë±ìŠ¤: ì‚¬ìš©ìë³„ í™œì„± ì ê¸ˆ ì¡°íšŒ ìµœì í™”
CREATE INDEX idx_active_locks_user_id ON active_locks(user_id);

-- ì¸ë±ìŠ¤: ê¸°ê¸°ë³„ í™œì„± ì ê¸ˆ ì¡°íšŒ ìµœì í™”
CREATE INDEX idx_active_locks_device_id ON active_locks(device_id) WHERE device_id IS NOT NULL;

-- ì¸ë±ìŠ¤: ì¢…ë£Œ ì‹œê°„ ê¸°ì¤€ ì •ë¦¬ ì‘ì—… ìµœì í™”
CREATE INDEX idx_active_locks_ends_at ON active_locks(ends_at);

-- ì¸ë±ìŠ¤: ë³µí•© ì¸ë±ìŠ¤ - ì‚¬ìš©ìë³„ í™œì„± ì ê¸ˆ ë° ì¢…ë£Œ ì‹œê°„
CREATE INDEX idx_active_locks_user_ends ON active_locks(user_id, ends_at);

-- ì œì•½ì‚¬í•­: ì¢…ë£Œ ì‹œê°„ì€ ì‹œì‘ ì‹œê°„ë³´ë‹¤ ì´í›„ì—¬ì•¼ í•¨
ALTER TABLE active_locks ADD CONSTRAINT chk_active_locks_time_order 
  CHECK (ends_at > started_at);

-- ì°¸ê³ : ê¸°ê¸°ë‹¹ í•˜ë‚˜ì˜ í™œì„± ì ê¸ˆë§Œ í—ˆìš©í•˜ë ¤ë©´ ì• í”Œë¦¬ì¼€ì´ì…˜ ë ˆë²¨ì—ì„œ ì²˜ë¦¬
-- PostgreSQLì˜ NOW()ëŠ” STABLE í•¨ìˆ˜ì´ë¯€ë¡œ ë¶€ë¶„ ì¸ë±ìŠ¤ì— ì‚¬ìš© ë¶ˆê°€
-- Lambda APIì˜ POST /locks/startì—ì„œ ê¸°ì¡´ í™œì„± ì ê¸ˆì„ ë¨¼ì € ì‚­ì œí•˜ëŠ” ë¡œì§ìœ¼ë¡œ ëŒ€ì²´:
-- DELETE FROM active_locks WHERE user_id = $1 AND ends_at > NOW();

-- ë§Œë£Œëœ ì ê¸ˆ ì •ë¦¬ í•¨ìˆ˜ (ì„ íƒì‚¬í•­ - ì£¼ê¸°ì ìœ¼ë¡œ ì‹¤í–‰)
CREATE OR REPLACE FUNCTION cleanup_expired_locks()
RETURNS INTEGER AS $$
DECLARE
  deleted_count INTEGER;
BEGIN
  DELETE FROM active_locks WHERE ends_at < NOW();
  GET DIAGNOSTICS deleted_count = ROW_COUNT;
  RETURN deleted_count;
END;
$$ LANGUAGE plpgsql;

$$ LANGUAGE plpgsql;


-- 5. ğŸ“… ì˜ˆì•½ëœ ì ê¸ˆ(Scheduled Locks) ê´€ë¦¬ í…Œì´ë¸”
-- ìë…€ë³„ ë°˜ë³µ ì ê¸ˆ ìŠ¤ì¼€ì¤„ ê´€ë¦¬
DROP TABLE IF EXISTS child_schedules CASCADE;

CREATE TABLE child_schedules (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  
  -- ìŠ¤ì¼€ì¤„ ëŒ€ìƒ
  child_user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  
  -- ìŠ¤ì¼€ì¤„ ì •ë³´
  name VARCHAR(100) NOT NULL,
  
  -- ì‹œê°„ ì„¤ì •
  start_time TIME NOT NULL,
  end_time TIME NOT NULL,
  days JSONB NOT NULL, -- ìš”ì¼ ë°°ì—´ ["MON", "TUE", ...]
  
  -- ì ê¸ˆ ì„¤ì •
  lock_type lock_type_enum NOT NULL DEFAULT 'FULL',
  allowed_apps JSONB,
  blocked_apps JSONB,
  allowed_categories JSONB,
  blocked_categories JSONB,
  
  -- ìƒíƒœ (í™œì„±í™”/ë¹„í™œì„±í™”)
  is_active BOOLEAN DEFAULT TRUE,
  
  -- ë©”íƒ€ë°ì´í„°
  created_by UUID REFERENCES users(id),
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now(),
  
  CONSTRAINT chk_schedule_time CHECK (start_time < end_time)
);

-- ì¸ë±ìŠ¤: ìë…€ë³„ ìŠ¤ì¼€ì¤„ ì¡°íšŒ
CREATE INDEX idx_child_schedules_child ON child_schedules(child_user_id);

-- ì¸ë±ìŠ¤: í™œì„± ìŠ¤ì¼€ì¤„ í•„í„°ë§
CREATE INDEX idx_child_schedules_active ON child_schedules(is_active);

-- updated_at ìë™ ê°±ì‹  íŠ¸ë¦¬ê±° ì—°ë™
CREATE TRIGGER trg_child_schedules_updated_at
BEFORE UPDATE ON child_schedules
FOR EACH ROW
EXECUTE FUNCTION set_updated_at();

-- 4. ğŸ  ë¶€ëª¨/í™ˆ ì¼€ì–´ ì‚¬ì „ ë“±ë¡(Preset) ê¸°ë³¸ ë°ì´í„° ì‚½ì…
DELETE FROM preset_policies WHERE scope = 'SYSTEM';

-- HOME ì¹´í…Œê³ ë¦¬ (ë¶€ëª¨ìš©)
INSERT INTO preset_policies (id, scope, category, name, description, purpose, lock_type, allowed_categories, blocked_categories, allowed_apps, default_duration_minutes)
VALUES 
  (gen_random_uuid(), 'SYSTEM', 'HOME', 'ğŸ’¡ ì§‘ì¤‘ í•™ìŠµ', 'ì§‘ì—ì„œ ì§‘ì¤‘í•´ì„œ ê³µë¶€í•  ë•Œ ì‚¬ìš©í•©ë‹ˆë‹¤.', 'LOCK_ONLY', 'APP_ONLY', '["EDUCATION", "UTILITIES"]', '["GAMES", "SOCIAL", "ENTERTAINMENT"]', '[]', 60),
  (gen_random_uuid(), 'SYSTEM', 'HOME', 'ğŸ± ì‹ì‚¬ ì‹œê°„', 'ì‹ì‚¬ ì¤‘ ìŠ¤ë§ˆíŠ¸í° ì‚¬ìš©ì„ ë©ˆì¶”ê²Œ í•©ë‹ˆë‹¤.', 'LOCK_ONLY', 'FULL', '[]', '[]', '[]', 30),
  (gen_random_uuid(), 'SYSTEM', 'HOME', 'ğŸŒ™ ì·¨ì¹¨ ëª¨ë“œ', 'ìë…€ì˜ ìˆ˜ë©´ì„ ìœ„í•´ ëª¨ë“  ì•±ì„ ì°¨ë‹¨í•©ë‹ˆë‹¤.', 'LOCK_ONLY', 'FULL', '[]', '[]', '[]', 480),
  (gen_random_uuid(), 'SYSTEM', 'HOME', 'ğŸ“º ìœ íŠœë¸Œ ì œí•œ', 'ê³¼ë„í•œ ì˜ìƒ ì‹œì²­ì„ ë°©ì§€í•©ë‹ˆë‹¤.', 'LOCK_ONLY', 'APP_ONLY', '[]', '["ENTERTAINMENT"]', '["com.google.ios.youtube"]', 60);

-- SCHOOL ì¹´í…Œê³ ë¦¬ (êµì‚¬ìš©)
INSERT INTO preset_policies (id, scope, category, name, description, purpose, lock_type, allowed_categories, blocked_categories, allowed_apps, default_duration_minutes)
VALUES 
  (gen_random_uuid(), 'SYSTEM', 'SCHOOL', 'ğŸ« ìˆ˜ì—… ì§‘ì¤‘', 'ìˆ˜ì—… ì¤‘ í•™ìŠµ ì•±ë§Œ í—ˆìš©í•©ë‹ˆë‹¤.', 'LOCK_AND_ATTENDANCE', 'APP_ONLY', '["EDUCATION"]', '["GAMES", "SOCIAL"]', '[]', 50),
  (gen_random_uuid(), 'SYSTEM', 'SCHOOL', 'ğŸ“ ì‹œí—˜ ëª¨ë“œ', 'ì‹œí—˜ ì¤‘ ëª¨ë“  ê¸°ê¸° ì‚¬ìš©ì„ ê¸ˆì§€í•©ë‹ˆë‹¤.', 'LOCK_ONLY', 'FULL', '[]', '[]', '[]', 120);

-- COMMON ì¹´í…Œê³ ë¦¬
INSERT INTO preset_policies (id, scope, category, name, description, purpose, lock_type, allowed_categories, blocked_categories, allowed_apps, default_duration_minutes)
VALUES 
  (gen_random_uuid(), 'SYSTEM', 'COMMON', 'âœ… ì¶œì„ ì²´í¬', 'ì ê¸ˆ ì—†ì´ ì¶œì„ë§Œ ê¸°ë¡í•©ë‹ˆë‹¤.', 'ATTENDANCE_ONLY', NULL, NULL, NULL, NULL, NULL);


-- [F] personal_presets í…Œì´ë¸” (ê°œì¸ ì‚¬ìš©ììš© í”„ë¦¬ì…‹)
CREATE TABLE personal_presets (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  
  name VARCHAR(100) NOT NULL,
  description TEXT,
  
  lock_type lock_type_enum NOT NULL DEFAULT 'FULL',
  preset_type VARCHAR(20) DEFAULT 'INSTANT', -- 'INSTANT' or 'SCHEDULED'
  allowed_apps JSONB,
  blocked_apps JSONB,
  allowed_categories JSONB,
  blocked_categories JSONB,
  
  duration_minutes INT, -- For INSTANT
  start_time TIME,      -- For SCHEDULED
  end_time TIME,        -- For SCHEDULED
  days JSONB,           -- For SCHEDULED (e.g. ["ì›”", "í™”"])
  
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);

CREATE INDEX idx_personal_presets_user_id ON personal_presets(user_id);

-- updated_at ìë™ ê°±ì‹  íŠ¸ë¦¬ê±° ì—°ë™
CREATE TRIGGER trg_personal_presets_updated_at
BEFORE UPDATE ON personal_presets
FOR EACH ROW
EXECUTE FUNCTION set_updated_at();

-- Universal Apps (Cross-platform mapping)
CREATE TABLE universal_apps (
  id SERIAL PRIMARY KEY,
  universal_id TEXT UNIQUE NOT NULL, -- youtube, kakaotalk
  ios_bundle_ids TEXT[],
  android_package_names TEXT[]
);