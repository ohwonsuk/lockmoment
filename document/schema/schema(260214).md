-- LockMoment Schema Upgrade (260214)
-- ì‚¬ì „ ë“±ë¡(Preset) ì¹´í…Œê³ ë¦¬í™” ë° ë¶€ëª¨/í™ˆ ì¼€ì–´ ë°ì´í„° ë°˜ì˜

-- 1. ì‹ ê·œ ì¹´í…Œê³ ë¦¬ Enum ì¶”ê°€ (ì—†ì„ ê²½ìš° ìƒì„±)
DO $$ BEGIN
    IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'preset_category_enum') THEN
        CREATE TYPE preset_category_enum AS ENUM ('HOME', 'SCHOOL', 'COMMON');
    END IF;
END $$;

-- 2. preset_policies ë° lock_policies í…Œì´ë¸” ë³´ì™„
ALTER TABLE preset_policies ADD COLUMN IF NOT EXISTS category preset_category_enum DEFAULT 'COMMON';
ALTER TABLE lock_policies ADD COLUMN IF NOT EXISTS title VARCHAR(100);

-- 3. ê¸°ì¡´ í…Œì´ë¸” ì´ˆê¸°í™” ë° ì¬ìƒì„± (ì •í•©ì„± ë³´ì¥)
DROP TABLE IF EXISTS qr_device_usage CASCADE;
DROP TABLE IF EXISTS qr_codes CASCADE;

-- QR ì½”ë“œ í…Œì´ë¸” (hmac_sig í¬í•¨)
CREATE TABLE qr_codes (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  qr_type qr_type_enum NOT NULL,
  purpose qr_purpose_enum NOT NULL,
  preset_id UUID NULL REFERENCES preset_policies(id),
  lock_policy_id UUID NULL REFERENCES lock_policies(id),
  target_type qr_target_type_enum NOT NULL,
  target_id UUID NOT NULL,
  schedule_mode qr_schedule_mode_enum NOT NULL DEFAULT 'IMMEDIATE',
  valid_from TIMESTAMPTZ NULL,
  valid_to TIMESTAMPTZ NULL,
  one_time BOOLEAN DEFAULT FALSE,
  max_scan_count INT NULL,
  status qr_status_enum DEFAULT 'ACTIVE',
  hmac_sig VARCHAR(255),
  created_by UUID NOT NULL REFERENCES users(id),
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);

-- QR ìŠ¤ìº” ì‚¬ìš© ê¸°ë¡ (ìŠ¤ìº” ì‹œ ë””ë°”ì´ìŠ¤ ì²´í¬ ê°•í™”)
CREATE TABLE qr_device_usage (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  qr_id UUID NOT NULL REFERENCES qr_codes(id) ON DELETE CASCADE,
  user_id UUID NULL REFERENCES users(id), -- ë¹„ë¡œê·¸ì¸ ìŠ¤ìº” ê°€ëŠ¥ì„± ëŒ€ë¹„ NULL í—ˆìš©
  device_id UUID NULL REFERENCES devices(id), -- ì—°ë™ ì „ ê¸°ê¸° ìŠ¤ìº” ê°€ëŠ¥ì„± ëŒ€ë¹„ NULL í—ˆìš©
  raw_device_uuid TEXT NULL, -- ì¡°íšŒë˜ì§€ ì•Šì€ ê¸°ê¸°ì˜ ì‹ë³„ê°’ ê¸°ë¡ìš©
  scanned_at TIMESTAMPTZ DEFAULT now(),
  lock_applied BOOLEAN DEFAULT FALSE,
  failure_reason TEXT NULL
);

-- 4. ğŸ  ë¶€ëª¨/í™ˆ ì¼€ì–´ ì‚¬ì „ ë“±ë¡(Preset) ê¸°ë³¸ ë°ì´í„° ì‚½ì…
DELETE FROM preset_policies WHERE scope = 'SYSTEM';

-- HOME ì¹´í…Œê³ ë¦¬ (ë¶€ëª¨ìš©)
INSERT INTO preset_policies (id, scope, category, name, description, purpose, lock_type, allowed_categories, blocked_categories, allowed_apps, default_duration_minutes)
VALUES 
  (gen_random_uuid(), 'SYSTEM', 'HOME', 'ğŸ’¡ ì§‘ì¤‘ í•™ìŠµ', 'ì§‘ì—ì„œ ì§‘ì¤‘í•´ì„œ ê³µë¶€í•  ë•Œ ì‚¬ìš©í•©ë‹ˆë‹¤.', 'LOCK_ONLY', 'APP_ONLY', '["EDUCATION", "UTILITIES"]', '["GAMES", "SOCIAL", "ENTERTAINMENT"]', '[]', 60),
  (gen_random_uuid(), 'SYSTEM', 'HOME', 'ğŸ± ì‹ì‚¬ ì‹œê°„', 'ì‹ì‚¬ ì¤‘ ìŠ¤ë§ˆíŠ¸í° ì‚¬ìš©ì„ ë©ˆì¶”ê²Œ í•©ë‹ˆë‹¤.', 'LOCK_ONLY', 'FULL', '[]', '[]', '[]', 30),
  (gen_random_uuid(), 'SYSTEM', 'HOME', 'ğŸŒ™ ì·¨ì¹¨ ëª¨ë“œ', 'ìë…€ì˜ ìˆ˜ë©´ì„ ìœ„í•´ ëª¨ë“  ì•±ì„ ì°¨ë‹¨í•©ë‹ˆë‹¤.', 'LOCK_ONLY', 'FULL', '[]', '[]', '[]', 480),
  (gen_random_uuid(), 'SYSTEM', 'HOME', 'ğŸ“º ìœ íŠœë¸Œ ì œí•œ', 'ê³¼ë„í•œ ì˜ìƒ ì‹œì²­ì„ ë°©ì§€í•©ë‹ˆë‹¤.', 'LOCK_ONLY', 'APP_ONLY', '[]', '["ENTERTAINMENT"]', '["com.google.ios.youtube"]', 60);

-- SCHOOL ì¹´í…Œê³ ë¦¬ (êµì‚¬ìš©)
INSERT INTO preset_policies (id, scope, category, name, description, purpose, lock_type, allowed_categories, blocked_categories, allowed_apps, default_duration_minutes)
VALUES 
  (gen_random_uuid(), 'SYSTEM', 'SCHOOL', 'ğŸ« ìˆ˜ì—… ì§‘ì¤‘', 'ìˆ˜ì—… ì¤‘ í•™ìŠµ ì•±ë§Œ í—ˆìš©í•©ë‹ˆë‹¤.', 'LOCK_AND_ATTENDANCE', 'APP_ONLY', '["EDUCATION"]', '["GAMES", "SOCIAL"]', '[]', 50),
  (gen_random_uuid(), 'SYSTEM', 'SCHOOL', 'ğŸ“ ì‹œí—˜ ëª¨ë“œ', 'ì‹œí—˜ ì¤‘ ëª¨ë“  ê¸°ê¸° ì‚¬ìš©ì„ ê¸ˆì§€í•©ë‹ˆë‹¤.', 'LOCK_ONLY', 'FULL', '[]', '[]', '[]', 120);

-- COMMON ì¹´í…Œê³ ë¦¬
INSERT INTO preset_policies (id, scope, category, name, description, purpose, lock_type, allowed_categories, blocked_categories, allowed_apps, default_duration_minutes)
VALUES 
  (gen_random_uuid(), 'SYSTEM', 'COMMON', 'âœ… ì¶œì„ ì²´í¬', 'ì ê¸ˆ ì—†ì´ ì¶œì„ë§Œ ê¸°ë¡í•©ë‹ˆë‹¤.', 'ATTENDANCE_ONLY', NULL, NULL, NULL, NULL, NULL);
