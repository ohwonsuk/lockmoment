-- LockMoment Schema Upgrade (260214)
-- 사전 등록(Preset) 카테고리화 및 부모/홈 케어 데이터 반영

-- 1. 신규 카테고리 Enum 추가 (없을 경우 생성)
DO $$ BEGIN
    IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'preset_category_enum') THEN
        CREATE TYPE preset_category_enum AS ENUM ('HOME', 'SCHOOL', 'COMMON');
    END IF;
END $$;

-- 2. preset_policies 보완
ALTER TABLE preset_policies ADD COLUMN IF NOT EXISTS category preset_category_enum DEFAULT 'COMMON';

-- 3. 기존 테이블 초기화 및 재생성 (정합성 보장)
-- 관계 순서에 따라 삭제 (CASCADE 지원)
DROP TABLE IF EXISTS preset_usage CASCADE;
DROP TABLE IF EXISTS qr_device_usage CASCADE;
DROP TABLE IF EXISTS qr_codes CASCADE;
DROP TABLE IF EXISTS lock_policies CASCADE;

-- [A] lock_policies 테이블 (신규 필드 포함 정식 생성)
CREATE TABLE lock_policies (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  preset_id UUID REFERENCES preset_policies(id),
  
  title VARCHAR(100), -- 정책 명칭
  purpose preset_purpose_enum NOT NULL DEFAULT 'LOCK_ONLY',
  
  lock_type lock_type_enum NOT NULL,
  allowed_categories JSONB,
  blocked_categories JSONB,
  allowed_apps JSONB,
  
  duration_minutes INT NOT NULL,
  
  -- 예약 정보 필드 (260215)
  time_window VARCHAR(50), -- 예: "09:00-10:00"
  days JSONB,              -- 예: ["월", "화"]

  is_customized BOOLEAN DEFAULT FALSE,

  created_by UUID REFERENCES users(id),
  created_at TIMESTAMPTZ DEFAULT now()
);

-- [B] QR 코드 테이블
CREATE TABLE qr_codes (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  qr_type qr_type_enum NOT NULL,
  purpose qr_purpose_enum NOT NULL,
  preset_id UUID NULL REFERENCES preset_policies(id),
  lock_policy_id UUID NULL REFERENCES lock_policies(id) ON DELETE CASCADE,
  target_type qr_target_type_enum NOT NULL,
  target_id UUID NOT NULL,
  schedule_mode qr_schedule_mode_enum NOT NULL DEFAULT 'IMMEDIATE',
  valid_from TIMESTAMPTZ NULL,
  valid_to TIMESTAMPTZ NULL,
  one_time BOOLEAN DEFAULT FALSE,
  max_scan_count INT NULL,
  status qr_status_enum DEFAULT 'ACTIVE',
  hmac_sig VARCHAR(255),
  created_by UUID NOT NULL REFERENCES users(id),
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);

-- QR 스캔 사용 기록 (스캔 시 디바이스 체크 강화)
CREATE TABLE qr_device_usage (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  qr_id UUID NOT NULL REFERENCES qr_codes(id) ON DELETE CASCADE,
  user_id UUID NULL REFERENCES users(id), -- 비로그인 스캔 가능성 대비 NULL 허용
  device_id UUID NULL REFERENCES devices(id), -- 연동 전 기기 스캔 가능성 대비 NULL 허용
  raw_device_uuid TEXT NULL, -- 조회되지 않은 기기의 식별값 기록용
  scanned_at TIMESTAMPTZ DEFAULT now(),
  lock_applied BOOLEAN DEFAULT FALSE,
  failure_reason TEXT NULL
);

-- [D] preset_usage 테이블 (관계 복원)
CREATE TABLE preset_usage (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  preset_id UUID NOT NULL REFERENCES preset_policies(id) ON DELETE CASCADE,
  used_by UUID NOT NULL REFERENCES users(id),
  target_type preset_target_enum NOT NULL DEFAULT 'STUDENT', 
  target_id UUID NOT NULL,
  purpose preset_purpose_enum NOT NULL,
  applied_policy_id UUID REFERENCES lock_policies(id) ON DELETE SET NULL,
  applied_at TIMESTAMPTZ DEFAULT now()
);

-- [E] active_locks 테이블 (실시간 잠금 상태 추적)
-- 부모가 자녀의 현재 잠금 상태를 확인할 수 있도록 지원
CREATE TABLE active_locks (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  
  -- 잠금 대상
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  device_id UUID REFERENCES devices(id) ON DELETE CASCADE,
  
  -- 잠금 정보
  lock_name VARCHAR(100) NOT NULL,
  lock_type lock_type_enum NOT NULL,
  
  -- 시간 정보
  started_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  ends_at TIMESTAMPTZ NOT NULL,
  
  -- 잠금 정책 (선택사항)
  lock_policy_id UUID REFERENCES lock_policies(id) ON DELETE SET NULL,
  preset_id UUID REFERENCES preset_policies(id) ON DELETE SET NULL,
  
  -- 잠금 설정
  allowed_apps JSONB,
  blocked_apps JSONB,
  prevent_app_removal BOOLEAN DEFAULT FALSE,
  
  -- 메타데이터
  source VARCHAR(50), -- 'MANUAL', 'SCHEDULED', 'QR', 'PRESET'
  initiated_by UUID REFERENCES users(id), -- 잠금을 시작한 사용자 (부모/교사)
  
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- 인덱스: 사용자별 활성 잠금 조회 최적화
CREATE INDEX idx_active_locks_user_id ON active_locks(user_id);

-- 인덱스: 기기별 활성 잠금 조회 최적화
CREATE INDEX idx_active_locks_device_id ON active_locks(device_id) WHERE device_id IS NOT NULL;

-- 인덱스: 종료 시간 기준 정리 작업 최적화
CREATE INDEX idx_active_locks_ends_at ON active_locks(ends_at);

-- 인덱스: 복합 인덱스 - 사용자별 활성 잠금 및 종료 시간
CREATE INDEX idx_active_locks_user_ends ON active_locks(user_id, ends_at);

-- 제약사항: 종료 시간은 시작 시간보다 이후여야 함
ALTER TABLE active_locks ADD CONSTRAINT chk_active_locks_time_order 
  CHECK (ends_at > started_at);

-- 참고: 기기당 하나의 활성 잠금만 허용하려면 애플리케이션 레벨에서 처리
-- PostgreSQL의 NOW()는 STABLE 함수이므로 부분 인덱스에 사용 불가
-- Lambda API의 POST /locks/start에서 기존 활성 잠금을 먼저 삭제하는 로직으로 대체:
-- DELETE FROM active_locks WHERE user_id = $1 AND ends_at > NOW();

-- 만료된 잠금 정리 함수 (선택사항 - 주기적으로 실행)
CREATE OR REPLACE FUNCTION cleanup_expired_locks()
RETURNS INTEGER AS $$
DECLARE
  deleted_count INTEGER;
BEGIN
  DELETE FROM active_locks WHERE ends_at < NOW();
  GET DIAGNOSTICS deleted_count = ROW_COUNT;
  RETURN deleted_count;
END;
$$ LANGUAGE plpgsql;

$$ LANGUAGE plpgsql;


-- 5. 📅 예약된 잠금(Scheduled Locks) 관리 테이블
-- 자녀별 반복 잠금 스케줄 관리
DROP TABLE IF EXISTS child_schedules CASCADE;

CREATE TABLE child_schedules (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  
  -- 스케줄 대상
  child_user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  
  -- 스케줄 정보
  name VARCHAR(100) NOT NULL,
  
  -- 시간 설정
  start_time TIME NOT NULL,
  end_time TIME NOT NULL,
  days JSONB NOT NULL, -- 요일 배열 ["MON", "TUE", ...]
  
  -- 잠금 설정
  lock_type lock_type_enum NOT NULL DEFAULT 'FULL',
  allowed_apps JSONB,
  blocked_apps JSONB,
  allowed_categories JSONB,
  blocked_categories JSONB,
  
  -- 상태 (활성화/비활성화)
  is_active BOOLEAN DEFAULT TRUE,
  
  -- 메타데이터
  created_by UUID REFERENCES users(id),
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now(),
  
  CONSTRAINT chk_schedule_time CHECK (start_time < end_time)
);

-- 인덱스: 자녀별 스케줄 조회
CREATE INDEX idx_child_schedules_child ON child_schedules(child_user_id);

-- 인덱스: 활성 스케줄 필터링
CREATE INDEX idx_child_schedules_active ON child_schedules(is_active);

-- updated_at 자동 갱신 트리거 연동
CREATE TRIGGER trg_child_schedules_updated_at
BEFORE UPDATE ON child_schedules
FOR EACH ROW
EXECUTE FUNCTION set_updated_at();

-- 4. 🏠 부모/홈 케어 사전 등록(Preset) 기본 데이터 삽입
DELETE FROM preset_policies WHERE scope = 'SYSTEM';

-- HOME 카테고리 (부모용)
INSERT INTO preset_policies (id, scope, category, name, description, purpose, lock_type, allowed_categories, blocked_categories, allowed_apps, default_duration_minutes)
VALUES 
  (gen_random_uuid(), 'SYSTEM', 'HOME', '💡 집중 학습', '집에서 집중해서 공부할 때 사용합니다.', 'LOCK_ONLY', 'APP_ONLY', '["EDUCATION", "UTILITIES"]', '["GAMES", "SOCIAL", "ENTERTAINMENT"]', '[]', 60),
  (gen_random_uuid(), 'SYSTEM', 'HOME', '🍱 식사 시간', '식사 중 스마트폰 사용을 멈추게 합니다.', 'LOCK_ONLY', 'FULL', '[]', '[]', '[]', 30),
  (gen_random_uuid(), 'SYSTEM', 'HOME', '🌙 취침 모드', '자녀의 수면을 위해 모든 앱을 차단합니다.', 'LOCK_ONLY', 'FULL', '[]', '[]', '[]', 480),
  (gen_random_uuid(), 'SYSTEM', 'HOME', '📺 유튜브 제한', '과도한 영상 시청을 방지합니다.', 'LOCK_ONLY', 'APP_ONLY', '[]', '["ENTERTAINMENT"]', '["com.google.ios.youtube"]', 60);

-- SCHOOL 카테고리 (교사용)
INSERT INTO preset_policies (id, scope, category, name, description, purpose, lock_type, allowed_categories, blocked_categories, allowed_apps, default_duration_minutes)
VALUES 
  (gen_random_uuid(), 'SYSTEM', 'SCHOOL', '🏫 수업 집중', '수업 중 학습 앱만 허용합니다.', 'LOCK_AND_ATTENDANCE', 'APP_ONLY', '["EDUCATION"]', '["GAMES", "SOCIAL"]', '[]', 50),
  (gen_random_uuid(), 'SYSTEM', 'SCHOOL', '📝 시험 모드', '시험 중 모든 기기 사용을 금지합니다.', 'LOCK_ONLY', 'FULL', '[]', '[]', '[]', 120);

-- COMMON 카테고리
INSERT INTO preset_policies (id, scope, category, name, description, purpose, lock_type, allowed_categories, blocked_categories, allowed_apps, default_duration_minutes)
VALUES 
  (gen_random_uuid(), 'SYSTEM', 'COMMON', '✅ 출석 체크', '잠금 없이 출석만 기록합니다.', 'ATTENDANCE_ONLY', NULL, NULL, NULL, NULL, NULL);
